# GPT Actions OpenAPI Spec v3.10
openapi: 3.1.0

info:
  title: Game API
  description: Read/write access to battles and characters stored in Cloudflare D1 (Bearer-auth protected).
  version: "3.10"

# Changelog (commented out for easy copy/paste)
# - v3.10: allow chat_json on battle PUT; make state_json optional; include chat_json in Battle schema; add messages endpoints; fix array schema items.
# - v3.09: prior spec

servers:
  - url: "https://dungeon.delvus.net"

paths:
  /health:
    get:
      operationId: get_health
      summary: Health check (public)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                required: [ok]

  /hex/trace:
    post:
      operationId: hex_trace
      x-openai-isConsequential: false
      summary: Trace a line between two hexes (movement + LoS helpers)
      description: "Flat-top odd-q hex trace between two hexes. Returns distance_hexes, movement_line, ray_ordered, and supercover."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HexTraceRequest"
            examples:
              labels:
                value:
                  from: "A1"
                  to: "C9"
              coords:
                value:
                  from: { q: 0, r: 0 }
                  to: { q: 2, r: 8 }
              withBoard:
                value:
                  board: { cols: 17, rows: 11 }
                  from: "K2"
                  to: "F9"
      responses:
        "200":
          description: Trace result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HexTraceResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  board:
                    type: object
                    properties:
                      cols: { type: integer }
                      rows: { type: integer }
                required: [error]

  /battles:
    get:
      operationId: list_battles
      summary: List all battles (auth required)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of battles
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  rows:
                    type: array
                    items:
                      $ref: "#/components/schemas/Battle"
                required: [count, rows]
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token

  /battles/{battle_id}:
    get:
      operationId: get_battle
      summary: Get a single battle by ID (auth required)
      security:
        - bearerAuth: []
      parameters:
        - name: battle_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Battle found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Battle"
        "404":
          description: Battle not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  battle_id:
                    type: string
                required: [error, battle_id]
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token

    put:
      operationId: update_battle
      summary: Update a battle's stored state or chat log (auth required)
      x-openai-isConsequential: false
      description: >
        Updates the battle record. Provide state_json and/or chat_json. Either field
        may be provided as a JSON string (already stringified) or as an object/array
        (the server may stringify it before storing).
      security:
        - bearerAuth: []
      parameters:
        - name: battle_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state_json:
                  oneOf:
                    - type: string
                    - type: object
                chat_json:
                  oneOf:
                    - type: string
                    - type: array
                      items:
                        type: object
                name:
                  type: string
                campaign_id:
                  type: string
                version:
                  type: integer
              required: []
      responses:
        "200":
          description: Battle updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Battle"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                required: [error]
        "404":
          description: Battle not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  battle_id:
                    type: string
                required: [error, battle_id]
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token

  /messages:
    get:
      operationId: list_messages
      summary: List chat messages (auth required)
      security:
        - bearerAuth: []
      parameters:
        - name: battle_id
          in: query
          required: false
          schema:
            type: string
        - name: campaign_id
          in: query
          required: false
          schema:
            type: string
        - name: since_ts
          in: query
          required: false
          schema:
            type: integer
        - name: limit
          in: query
          required: false
          schema:
            type: integer
      responses:
        "200":
          description: List of messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  rows:
                    type: array
                    items:
                      $ref: "#/components/schemas/Message"
                required: [count, rows]
        "400":
          description: Missing campaign_id or battle_id
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token

    post:
      operationId: create_message
      summary: Append a chat message (auth required)
      x-openai-isConsequential: false
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                chat_id:
                  type: string
                campaign_id:
                  type: string
                battle_id:
                  type: string
                speaker:
                  type: string
                speaker_id:
                  type: string
                text:
                  type: string
                type:
                  type: string
                status:
                  type: string
              required: [speaker, text]
      responses:
        "200":
          description: Message created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  row:
                    $ref: "#/components/schemas/Message"
                required: [ok, row]
        "400":
          description: Invalid request
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token

  /characters:
    post:
      operationId: create_character
      summary: Create a character (auth required)
      x-openai-isConsequential: false
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                character_id:
                  type: string
                campaign_id:
                  type: string
                player_id:
                  type: string
                name:
                  type: string
                sheet_json:
                  oneOf:
                    - type: object
                    - type: string
                notes_text:
                  type: string
              required: [campaign_id, player_id, name, sheet_json]
      responses:
        "200":
          description: Character created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "400":
          description: Invalid request
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token

  /characters/{character_id}:
    get:
      operationId: get_character
      summary: Get a single character by ID (auth required)
      security:
        - bearerAuth: []
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Character found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Character"
        "404":
          description: Character not found
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token

  /characters/{character_id}/portrait:
    put:
      operationId: upload_character_portrait
      summary: Upload a character portrait (jpg only, max 512kb)
      x-openai-isConsequential: false
      security:
        - bearerAuth: []
      parameters:
        - name: character_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          image/jpeg:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Portrait stored and character updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  character_id:
                    type: string
                  portrait_url:
                    type: string
                  version:
                    type: integer
                  updated_at:
                    type: integer
                required: [ok, character_id, portrait_url]
        "400":
          description: Invalid request (wrong content type or malformed)
        "413":
          description: Portrait too large
        "401":
          description: Missing Authorization header
        "403":
          description: Invalid token
        "404":
          description: Character not found

  /hex/cone:
    post:
      operationId: hex_cone
      summary: Compute cone (sector) area of effect on a hex grid
      description: Returns hex labels in an angular sector from origin=from aimed at to, bounded by range_hexes.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HexConeRequest'
      responses:
        '200':
          description: Cone result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HexConeResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

  schemas:
    Battle:
      type: object
      properties:
        battle_id:
          type: string
        campaign_id:
          type: string
        name:
          type: string
        state_json:
          type: [string, "null"]
        chat_json:
          type: [string, "null"]
        version:
          type: integer
        updated_at:
          type: integer
      required: [battle_id, campaign_id, name, version, updated_at]

    Message:
      type: object
      properties:
        chat_id:
          type: string
        campaign_id:
          type: [string, "null"]
        battle_id:
          type: [string, "null"]
        speaker:
          type: string
        speaker_id:
          type: [string, "null"]
        text:
          type: string
        type:
          type: string
        status:
          type: string
        created_at:
          type: integer
      required: [chat_id, speaker, text, created_at]

    Character:
      type: object
      properties:
        character_id:
          type: string
        campaign_id:
          type: string
        player_id:
          type: string
        name:
          type: string
        sheet_json:
          type: [string, "null"]
        notes_text:
          type: [string, "null"]
        version:
          type: integer
        created_at:
          type: integer
        updated_at:
          type: integer
      required: [character_id, campaign_id, player_id, name, version]

    HexBoard:
      type: object
      description: Hex grid board size.
      properties:
        cols:
          type: integer
          minimum: 1
        rows:
          type: integer
          minimum: 1
      required: [cols, rows]

    HexCoord:
      type: object
      description: Zero-based coordinates (q=column, r=row). r is bottom-up (A1 => r=0).
      properties:
        q:
          type: integer
          minimum: 0
        r:
          type: integer
          minimum: 0
      required: [q, r]

    HexRef:
      description: A hex, either as a label (e.g. "K2") or as coordinates.
      oneOf:
        - type: string
          pattern: "^[A-Z][0-9]{1,3}$"
          description: Label form like "A1".
        - $ref: "#/components/schemas/HexCoord"

    HexTraceRequest:
      type: object
      properties:
        board:
          $ref: "#/components/schemas/HexBoard"
        from:
          $ref: "#/components/schemas/HexRef"
        to:
          $ref: "#/components/schemas/HexRef"
      required: [from, to]

    HexTraceResponse:
      type: object
      properties:
        ok:
          type: boolean
        board:
          type: object
          properties:
            cols: { type: integer }
            rows: { type: integer }
            layout: { type: string, enum: [flat_top] }
            offset: { type: string, enum: [odd_q] }
          required: [cols, rows, layout, offset]
        from:
          type: object
          properties:
            q: { type: integer }
            r: { type: integer }
            label: { type: string }
          required: [q, r, label]
        to:
          type: object
          properties:
            q: { type: integer }
            r: { type: integer }
            label: { type: string }
          required: [q, r, label]
        distance_hexes:
          type: integer
          minimum: 0
        movement_steps:
          type: integer
          minimum: 0
        movement_line:
          type: array
          items:
            type: string
        ray_ordered:
          type: array
          items:
            type: string
        supercover:
          type: array
          items:
            type: string
      required:
        - ok
        - board
        - from
        - to
        - distance_hexes
        - movement_steps
        - movement_line
        - ray_ordered
        - supercover

    HexConeRequest:
      type: object
      properties:
        board:
          $ref: "#/components/schemas/HexBoard"
        from:
          type: string
          description: Origin hex label (e.g., K2)
          pattern: "^[A-Z][0-9]{1,3}$"
        to:
          type: string
          description: Aim hex label (e.g., F9)
          pattern: "^[A-Z][0-9]{1,3}$"
        range_hexes:
          type: integer
          description: Range of the cone in hexes (cube distance)
          minimum: 0
        cone_angle_deg:
          type: number
          description: Cone angle in degrees
          minimum: 0
          maximum: 360
        include_origin:
          type: boolean
          description: Whether to include the origin hex in affected_hexes
          default: false
      required: [from, to, range_hexes, cone_angle_deg]

    HexConeResponse:
      type: object
      properties:
        ok:
          type: boolean
        mode:
          type: string
          description: Constant string "CONE".
        origin:
          type: string
          pattern: "^[A-Z][0-9]{1,3}$"
        aim:
          type: string
          pattern: "^[A-Z][0-9]{1,3}$"
        range_hexes:
          type: integer
          minimum: 0
        cone_angle_deg:
          type: number
        include_origin:
          type: boolean
        first_step:
          type: [string, "null"]
          description: The first hex step toward the aim point (often useful to force the near-ring inclusion).
          pattern: "^[A-Z][0-9]{1,3}$"
        affected_hexes_count:
          type: integer
          minimum: 0
        affected_hexes:
          type: array
          items:
            type: string
            pattern: "^[A-Z][0-9]{1,3}$"
      required: [ok, affected_hexes_count, affected_hexes]
