<!-- Battlemat v7.11 -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Battlemat 3</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0c0f14;
      --panel: #131722;
      --panel-2: #0f141c;
      --accent: #6fd3ff;
      --text: #e6ecf3;
      --muted: #97a2b3;
      --danger: #ff7a7a;
      --success: #63d18d;
      --grid: rgba(255,255,255,0.06);
      --room-outline: rgba(255,255,255,0.18);
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, sans-serif;
      overflow: hidden;
    }

    #app {
      display: grid;
      grid-template-columns: 1fr 320px;
      height: 100vh;
    }

    #canvasWrap {
      position: relative;
      overflow: hidden;
      background: var(--bg);
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    #toolbar {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      padding: 8px 10px;
      background: rgba(15,20,28,0.85);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      backdrop-filter: blur(8px);
      z-index: 10;
    }

    .toolbar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #toolbar select, #toolbar input, #toolbar button {
      background: #0f141c;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 13px;
    }

    #toolbar button {
      cursor: pointer;
    }

    #toolbar .toolBtn.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(111,211,255,0.35) inset;
    }

    #toolbar .status {
      padding: 0 6px;
      font-size: 12px;
      color: var(--muted);
    }

    #toolbar .mini {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    #toolbar .mini input {
      width: 14px;
      height: 14px;
      accent-color: var(--accent);
    }

    #toolbar .polyTools input[type="range"] {
      width: 90px;
      height: 18px;
      padding: 0;
    }

    #toolbar .mapInput {
      width: 60px;
      min-width: 60px;
      height: 22px;
      padding: 2px 12px 2px 6px;
      font-size: 12px;
    }

    .toolbar-col {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .mapLabel {
      font-size: 11px;
      color: var(--muted);
    }

    #mapSelect {
      min-width: 160px;
    }

    #tokenSource {
      min-width: 180px;
    }

    .toolGroup {
      display: none;
      align-items: center;
      gap: 8px;
    }

    #navBar {
      position: absolute;
      right: 12px;
      top: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: rgba(15,20,28,0.85);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      backdrop-filter: blur(8px);
      z-index: 10;
    }

    #navBar button, #navBar input, #navBar select {
      background: #0f141c;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      font-size: 13px;
    }

    #navBar .status {
      padding: 0 6px;
      font-size: 12px;
      color: var(--muted);
    }

    #navBar .mini {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    #navBar .mini input {
      width: 14px;
      height: 14px;
      accent-color: var(--accent);
    }

    #navBar .mini select {
      background: #0f141c;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      font-size: 12px;
      padding: 2px 6px;
    }

    #navBar .toggles {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .polyTools {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .polyTools input[type="range"] {
      width: 90px;
    }

    .zoomBlock {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }

    .zoomRow {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .zoomButtons {
      display: grid;
      grid-template-columns: 28px auto 28px;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #ff5c5c;
    }

    .zoomButtons button {
      width: 28px;
      height: 28px;
      padding: 0;
      line-height: 1;
      font-size: 16px;
      cursor: pointer;
    }

    #zoomLevel {
      text-align: center;
      min-width: 48px;
      font-weight: 600;
    }

    .panPad {
      display: grid;
      grid-template-columns: 28px 28px 28px;
      grid-template-rows: 24px 28px 24px;
      grid-template-areas:
        ". up ."
        "left . right"
        ". down .";
      gap: 4px;
    }

    #panUp { grid-area: up; transform: translateY(12px); }
    #panDown { grid-area: down; transform: translateY(-12px); }
    #panLeft { grid-area: left; }
    #panRight { grid-area: right; }

    .panPad button {
      cursor: pointer;
      width: 28px;
      height: 28px;
      padding: 0;
      line-height: 1;
    }

    #sidebar {
      background: var(--panel);
      border-left: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
    }
    section {
      background: var(--panel-2);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 10px;
    }

    section h3 {
      margin: 0 0 8px 0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .collapseBtn {
      background: #0f141c;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      width: 22px;
      height: 22px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    section.collapsed .sectionBody {
      display: none;
    }

    section.collapsed .collapseBtn {
      transform: rotate(-90deg);
    }

    .row {
      display: grid;
      grid-template-columns: 90px 1fr;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .row input, .row select, .row textarea {
      background: #0f141c;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 13px;
    }

    .row input[type="range"] {
      padding: 0;
      accent-color: #7fb3ff;
    }

    .row input[readonly] {
      opacity: 0.6;
    }

    #statusList {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 240px;
      overflow: auto;
    }

    .statusItem {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      align-items: center;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .statusItem .meta { color: var(--muted); font-size: 12px; }

    #statusMeta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .statusPill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .statusWrap {
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(15,20,28,0.6);
      overflow: hidden;
    }

    #statusTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    #statusTable thead th {
      text-align: left;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
      padding: 6px 8px;
    }

    #statusTable thead th:first-child { padding-left: 12px; }
    #statusTable tbody td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    #statusTable tbody tr:last-child td { border-bottom: none; }

    .statusNameCell { display: flex; align-items: center; gap: 6px; }
    .statusTurnMarker {
      width: 0; height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-left: 8px solid rgba(79,208,127,0.95);
    }
    .statusTurnMarker.inactive { border-left-color: transparent; }
    .statusName { font-weight: 600; }
    .status-friendly { color: #7fd3ff; }
    .status-neutral { color: var(--muted); }
    .status-hostile { color: rgba(255,140,110,0.95); }
    .statusRow.active { background: rgba(67,209,122,0.10); }
    .statusNum { text-align: center; font-variant-numeric: tabular-nums; }
    .statusCond { display: flex; align-items: center; gap: 6px; }
    .statusIntent {
      width: 14px; height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.06);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #8fe8b2;
    }
    .statusIntent.on {
      border-color: rgba(79,208,127,0.9);
      background: rgba(79,208,127,0.2);
    }

    #chatLog {
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.03);
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
      color: var(--text);
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .chatEntry {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      line-height: 1.3;
      position: relative;
      padding-left: 20px;
    }
    .chatEntry.ack {
      color: rgba(190,195,205,0.85);
    }
    .chatEntry.canceled {
      color: rgba(220,120,120,0.9);
      text-decoration: line-through;
    }
    .chatEntry.processed {
      color: rgba(180,185,195,0.9);
    }
    .chatFocusArrow {
      position: absolute;
      left: 4px;
      top: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 0;
      height: 0;
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      border-left: 10px solid rgba(120,220,140,0.9);
    }
    .chatSpeaker {
      font-weight: 600;
      color: #7fd3ff;
      margin-right: 4px;
      white-space: nowrap;
    }
    .chatSpeaker.dm { color: var(--muted); }
    .chatText { white-space: pre-wrap; }

    #chatBar {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #chatBar select,
    #chatBar input {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 12px;
    }
    #chatSpeaker { min-width: 120px; }
    #chatInput { flex: 1; }
    #chatSend {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }

    #inspectorEmpty {
      color: var(--muted);
      font-size: 13px;
    }

    .btnRow {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .btnRow button {
      flex: 1;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.12);
      background: #0f141c;
      color: var(--text);
      cursor: pointer;
    }

    .warning {
      color: var(--danger);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="canvasWrap">
      <canvas id="map"></canvas>
      <div id="toolbar">
        <div class="toolbar-row">
          <button id="toolSelect" class="toolBtn active">Select</button>
          <button id="toolPoly" class="toolBtn">Poly</button>
          <button id="toolRoof" class="toolBtn">Roof</button>
          <button id="toolOpening" class="toolBtn">Opening</button>
          <button id="toolObject" class="toolBtn">Object</button>
          <button id="toolToken" class="toolBtn">Token</button>
          <label class="status">Layer</label>
          <select id="layerSelect">
            <option value="all" selected>all</option>
            <option value="floors">floors</option>
            <option value="walls">walls</option>
            <option value="roofs">roofs</option>
            <option value="roof_shadows">roof_shadows</option>
            <option value="objects">objects</option>
            <option value="tokens">tokens</option>
          </select>
          <label class="mini"><input type="checkbox" id="handlesToggle" /> Handles</label>
          <label class="mini"><input type="checkbox" id="hideRoofsToggle" /> Hide Roofs</label>
          <label class="mini"><input type="checkbox" id="streetViewToggle" /> Street View</label>
          <label class="mini">Roof Line <input id="roofLineColor" type="color" value="#464a4f" /></label>
          <label class="mini">Line W <input id="roofLineWidth" class="mapInput" type="number" step="0.5" value="1.5" /></label>
          <button id="btnUndo">Undo</button>
          <label class="mini"><input type="checkbox" id="fogToggle" checked /> Fog</label>
          <button id="btnSave">Save</button>
          <div class="polyTools">
            <label class="mini">Polys <input id="polyAlpha" type="range" min="0" max="100" step="5" value="100" /></label>
            <label class="mini"><input type="checkbox" id="backdropToggle" checked /> Background</label>
          </div>
          <span id="saveStatus" class="status">DB: idle</span>
          <div id="openingGroup" class="toolGroup">
            <label class="status">Opening</label>
            <select id="openingKind">
              <option value="door.wood">door.wood</option>
              <option value="door">door</option>
              <option value="window">window</option>
              <option value="threshold">threshold</option>
              <option value="portal">portal</option>
              <option value="gate">gate</option>
            </select>
            <button id="openingOrientH" class="toolBtn">H</button>
            <button id="openingOrientV" class="toolBtn">V</button>
          </div>
          <div id="objectGroup" class="toolGroup">
            <label class="status">Object</label>
            <select id="objectKind">
              <option value="object">object</option>
              <option value="poi.view">poi.view</option>
              <option value="table.round">table.round</option>
              <option value="table.rect">table.rect</option>
              <option value="chair">chair</option>
              <option value="crate">crate</option>
              <option value="barrel">barrel</option>
              <option value="stairs">stairs</option>
              <option value="bed">bed</option>
            </select>
          </div>
          <div id="tokenGroup" class="toolGroup">
            <label class="status">Token</label>
            <select id="tokenKind">
              <option value="pc">pc</option>
              <option value="npc" selected>npc</option>
              <option value="monster">monster</option>
              <option value="creature">creature</option>
            </select>
            <select id="tokenSource" title="Token source"></select>
          </div>
        </div>
        <div class="toolbar-row">
          <label class="status">Map</label>
          <label class="mini">X <input id="mapOffsetX" class="mapInput" type="number" step="0.5" value="0" /></label>
          <label class="mini">Y <input id="mapOffsetY" class="mapInput" type="number" step="0.5" value="1.5" /></label>
          <label class="mini">Scale % <input id="mapScale" class="mapInput" type="number" step="1" value="370" /></label>
          <label class="mini">Rot° <input id="mapRot" class="mapInput" type="number" step="1" value="19" /></label>
          <div class="toolbar-col">
            <div class="mapLabel">Map</div>
            <select id="mapSelect"></select>
          </div>
          <div class="toolbar-col">
            <div class="mapLabel">Floor</div>
            <select id="floorSelect"></select>
          </div>
        </div>
      </div>
      <div id="navBar">
        <div class="panPad">
          <div></div>
          <button id="panUp" title="Pan up">↑</button>
          <div></div>
          <button id="panLeft" title="Pan left">←</button>
          <div></div>
          <button id="panRight" title="Pan right">→</button>
          <div></div>
          <button id="panDown" title="Pan down">↓</button>
          <div></div>
        </div>
        <div class="zoomBlock">
          <div class="zoomRow">
            <label class="status">Zoom</label>
            <input id="zoom" type="range" min="0.05" max="4" step="0.05" value="1" />
          </div>
          <div class="zoomButtons">
            <button id="zoomOut" title="Zoom out">−</button>
            <div id="zoomLevel">100%</div>
            <button id="zoomIn" title="Zoom in">+</button>
          </div>
        </div>
        <div class="toggles">
          <label class="mini"><input type="checkbox" id="labelBoldToggle" /> Bright Labels</label>
          <label class="mini"><input type="checkbox" id="hexGridToggle" checked /> Hexgrid</label>
          <label class="mini">Video
            <select id="videoQuality">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="ultra">Ultra</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <aside id="sidebar">
      <section data-section="status">
        <h3><span>Status</span><button type="button" class="collapseBtn" aria-label="Collapse Status">▾</button></h3>
        <div class="sectionBody">
          <div id="statusMeta"></div>
          <div class="statusWrap">
            <table id="statusTable">
              <thead>
                <tr>
                  <th>Actor</th>
                  <th class="statusNum">Init</th>
                  <th class="statusNum">HP</th>
                  <th>Cond</th>
                </tr>
              </thead>
              <tbody id="statusBody"></tbody>
            </table>
          </div>
        </div>
      </section>
      <section data-section="chat">
        <h3><span>Chat</span><button type="button" class="collapseBtn" aria-label="Collapse Chat">▾</button></h3>
        <div class="sectionBody">
          <div id="chatLog"></div>
          <div id="chatBar">
            <select id="chatSpeaker"></select>
            <button id="chatSend">Send</button>
            <input id="chatInput" type="text" placeholder="Type message..." />
          </div>
        </div>
      </section>

      <section data-section="inspector">
        <h3><span>Inspector</span><button type="button" class="collapseBtn" aria-label="Collapse Inspector">▾</button></h3>
        <div class="sectionBody">
          <div id="inspectorEmpty">Select something to edit.</div>
          <div id="inspectorFields" hidden></div>
        </div>
      </section>
    </aside>
  </div>
  <datalist id="floorKindList"></datalist>
  <datalist id="wallKindList"></datalist>
  <datalist id="openingKindList"></datalist>
  <datalist id="objectKindList"></datalist>
  <datalist id="tokenKindList"></datalist>

  <script type="module" src="/app/battlemat3/main.js"></script>
</body>
</html>

