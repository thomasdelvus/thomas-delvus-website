<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Sheet</title>
  <style>
    :root{
      --bg-deep:#0d1016;
      --bg-mid:#1a1f2a;
      --ink:#2b2416;
      --muted:#6a5c45;
      --accent:#b57a2c;
      --accent-2:#2c6fb5;
      --paper:#f1e4c7;
      --paper-2:#f7eed6;
      --paper-edge:#c8b08a;
      --panel:#f9f1dc;
      --shadow:rgba(0,0,0,0.22);
    }
    html,body{height:100%;margin:0;}
    body{
      font-family:"Garamond","Book Antiqua","Palatino Linotype",serif;
      background:
        radial-gradient(1200px 600px at 12% -10%, #1f2532 0%, rgba(31,37,50,0) 60%),
        radial-gradient(900px 500px at 110% 10%, #202632 0%, rgba(32,38,50,0) 65%),
        linear-gradient(180deg, var(--bg-deep), var(--bg-mid));
      color:var(--ink);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px 0;
      color:#e8edf7;
    }
    .brand{
      font-family:"Copperplate Gothic","Garamond","Book Antiqua",serif;
      letter-spacing:0.12em;
      text-transform:uppercase;
      font-size:12px;
      opacity:0.8;
    }
    .nav a{
      color:#e8edf7;
      text-decoration:none;
      border:1px solid rgba(255,255,255,0.22);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .nav a:hover{background:rgba(255,255,255,0.08);}
    .wrap{
      max-width:1180px;
      margin:18px auto 48px;
      padding:0 18px;
    }
    .sheet{
      background:
        url('/assets/sprites/parchment.png') center/cover no-repeat,
        linear-gradient(180deg, var(--paper-2), var(--paper));
      border:1px solid var(--paper-edge);
      border-radius:22px;
      box-shadow:0 18px 40px var(--shadow);
      padding:22px 22px 28px;
      position:relative;
      overflow:hidden;
    }
    .sheet:before{
      content:"";
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,0.02) 0px, rgba(0,0,0,0.02) 1px, transparent 1px, transparent 3px),
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0) 45%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0) 40%);
      opacity:0.45;
      pointer-events:none;
    }
    .sheet > *{position:relative;}
    .sheet-page{display:flex;flex-direction:column;gap:14px;animation:fadeIn 0.6s ease both;}
    .section{
      border:1px solid rgba(47,35,20,0.3);
      border-radius:18px;
      background:rgba(249,241,220,0.65);
      box-shadow:0 8px 18px rgba(0,0,0,0.12);
      overflow:hidden;
    }
    .section > summary{
      list-style:none;
      cursor:pointer;
      padding:10px 14px;
      font-size:12px;
      letter-spacing:0.22em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:12px;
      background:rgba(249,241,220,0.9);
      border-bottom:1px solid rgba(47,35,20,0.2);
    }
    .section > summary::-webkit-details-marker{display:none;}
    .section > summary::after{
      content:"▾";
      margin-left:auto;
      font-size:12px;
      color:rgba(47,35,20,0.6);
    }
    .section[open] > summary::after{content:"▴";}
    .section-body{padding:12px;}
    .section-grid{
      display:grid;
      grid-template-columns:1.4fr 0.8fr;
      gap:12px;
    }
    .equipment-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:12px;
    }
    .equip-col{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .treasure-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .treasure-table th,
    .treasure-table td{
      padding:6px 6px;
      border-bottom:1px solid rgba(0,0,0,0.1);
      text-align:left;
    }
    .treasure-table th{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .sheet-header{
      display:grid;
      grid-template-columns:1.2fr 1.8fr;
      gap:14px;
      align-items:start;
    }
    .name-block h1{
      margin:0;
      font-size:34px;
      letter-spacing:0.02em;
      font-family:"Copperplate Gothic","Garamond","Book Antiqua",serif;
    }
    .name-block .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }
    .header-grid{
      display:grid;
      grid-template-columns:repeat(5, minmax(0,1fr));
      gap:8px 10px;
    }
    .header-field{
      border:1px solid rgba(47,35,20,0.25);
      border-radius:10px;
      padding:6px 8px;
      background:rgba(249,241,220,0.8);
    }
    .header-field .label{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .header-field .value{font-size:14px;margin-top:4px;font-weight:600;}

    .sheet-grid{
      display:grid;
      grid-template-columns:110px 0.45fr 1.35fr 0.9fr;
      gap:12px;
    }
    .col{display:flex;flex-direction:column;gap:12px;min-width:0;min-height:0;}

    .panel{
      position:relative;
      border:1px solid rgba(47,35,20,0.28);
      border-radius:16px;
      background:rgba(249,241,220,0.95);
      padding:12px;
      box-shadow:0 6px 12px rgba(0,0,0,0.12);
    }
    .panel:before{
      content:"";
      position:absolute;
      inset:6px;
      border:1px solid rgba(47,35,20,0.18);
      border-radius:12px;
      pointer-events:none;
    }
    .panel h2{
      margin:0 0 8px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .panel-row{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .subsection{
      border:1px solid rgba(47,35,20,0.22);
      border-radius:12px;
      background:rgba(255,250,238,0.7);
      padding:8px 10px 10px;
    }
    .subsection h3{
      margin:0 0 6px 0;
      font-size:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .subsection + .subsection{margin-top:8px;}

    .ability-list{display:flex;flex-direction:column;gap:8px;}
    .ability{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      padding:6px 8px;
      border:1px dashed rgba(0,0,0,0.25);
      border-radius:12px;
      background:#fff8e7;
    }
    .ability .score{font-size:18px;font-weight:700;}
    .ability .label{font-size:11px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .ability .mod{font-size:12px;color:var(--accent-2);font-weight:700;}

    .mini-grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:8px;}
    .mini-box{
      border:1px solid rgba(0,0,0,0.15);
      border-radius:12px;
      padding:8px;
      text-align:center;
      background:#fff8e7;
    }
    .mini-box .label{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .mini-box .value{font-size:16px;font-weight:700;margin-top:6px;}
    #passiveBox .label{display:none;}
    #passiveBox .value{margin-top:0;}

    .hp-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px;
      text-align:center;
    }
    .hp-grid .box{
      border:1px solid rgba(0,0,0,0.15);
      border-radius:10px;
      background:#fff8e7;
      padding:8px 6px;
    }
    .hp-grid .label{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .hp-grid .value{font-size:16px;font-weight:700;margin-top:6px;}

    .list{display:flex;flex-direction:column;gap:6px;font-size:14px;}
    .pill-list{display:flex;flex-wrap:wrap;gap:6px;}
    .pill{display:inline-flex;padding:4px 10px;border-radius:999px;background:#efe2c6;border:1px solid rgba(0,0,0,0.15);font-size:12px;}

    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:6px 6px;border-bottom:1px solid rgba(0,0,0,0.1);text-align:left;}
    th{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}

    .portrait-frame{display:flex;flex-direction:column;gap:10px;}
    .portrait-visual{
      width:100%;
      aspect-ratio:3 / 4;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.12);
      overflow:hidden;
      background:#e6dcc3;
    }
    .portrait-visual img{width:100%;height:100%;object-fit:cover;display:block;}
    .portrait-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:0.12em;background:#f6ecd4;}

    .spells-columns{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px;}
    .spell-group{display:flex;flex-direction:column;gap:6px;}
    .spell-group h3{
      margin:0;
      font-size:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .spell-list{display:flex;flex-direction:column;gap:6px;}
    .spell-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:4px 8px;
      border-radius:999px;
      background:#efe2c6;
      border:1px solid rgba(0,0,0,0.12);
      font-size:12px;
      line-height:1.2;
    }
    .spell-level{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .treasure-grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:6px 10px;font-size:13px;}
    .treasure-grid div:nth-child(odd){color:var(--muted);}

    .page-two-grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:14px;}

    pre{margin:0;white-space:pre-wrap;font-family:"Courier New",Courier,monospace;background:#f4e8cf;border:1px solid rgba(0,0,0,0.12);border-radius:12px;padding:12px;}
    .empty{color:var(--muted);font-style:italic;}

    .status{text-align:center;color:#e8edf7;padding:30px 10px;font-size:16px;}
    .status .msg{display:inline-block;padding:12px 18px;border-radius:12px;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.18);}

    @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

    @media (max-width: 1200px){
      .sheet-header{grid-template-columns:1fr;}
      .header-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
      .sheet-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 820px){
      .sheet-grid{grid-template-columns:1fr;}
      .panel-row{grid-template-columns:1fr;}
      .section-grid{grid-template-columns:1fr;}
      .equipment-grid{grid-template-columns:1fr;}
    }
    @media (max-width: 640px){
      .header-grid{grid-template-columns:1fr;}
      .spells-columns{grid-template-columns:1fr;}
      .page-two-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Delvus Character Sheet</div>
    <div class="nav"><a id="backLink" href="/app/battlemat.html">Back to battlemat</a></div>
  </div>

  <div class="wrap">
    <div class="status" id="status"><div class="msg" id="statusMsg">Loading character...</div></div>

    <main class="sheet" id="sheet" hidden>
      <section class="sheet-page">
        <header class="sheet-header">
          <div class="name-block">
            <h1 id="charName">Unknown</h1>
            <div class="meta" id="charMeta"></div>
          </div>
          <div class="header-grid">
            <div class="header-field">
              <div class="label">Class & Level</div>
              <div class="value" id="fieldClassLevel">-</div>
            </div>
            <div class="header-field">
              <div class="label">Background</div>
              <div class="value" id="fieldBackground">-</div>
            </div>
            <div class="header-field">
              <div class="label">Race</div>
              <div class="value" id="fieldRace">-</div>
            </div>
            <div class="header-field">
              <div class="label">Alignment</div>
              <div class="value" id="fieldAlignment">-</div>
            </div>
            <div class="header-field">
              <div class="label">Experience</div>
              <div class="value" id="fieldXp">-</div>
            </div>
          </div>
        </header>

        <details class="section" open>
          <summary>Base Stats</summary>
          <div class="section-body">
            <div class="sheet-grid">
              <div class="col">
                <section class="panel">
                  <h2>Abilities</h2>
                  <div class="ability-list" id="abilityList"></div>
                </section>
              </div>

              <div class="col">
                <section class="panel">
                  <h2>Saves</h2>
                  <div class="list" id="savesList"></div>
                </section>

                <section class="panel">
                  <h2>Skills</h2>
                  <div class="list" id="skillsList"></div>
                </section>

                <section class="panel">
                  <h2>Passive Perception</h2>
                  <div class="mini-box" id="passiveBox">
                    <div class="label">Passive</div>
                    <div class="value" id="passiveValue">--</div>
                  </div>
                </section>
              </div>

              <div class="col">
                <section class="panel">
                  <h2>Combat</h2>
                  <div class="mini-grid" id="combatGrid"></div>
                </section>

                <section class="panel">
                  <h2>Hit Points</h2>
                  <div class="hp-grid">
                    <div class="box">
                      <div class="label">Max</div>
                      <div class="value" id="hpMax">--</div>
                    </div>
                    <div class="box">
                      <div class="label">Current</div>
                      <div class="value" id="hpCurrent">--</div>
                    </div>
                    <div class="box">
                      <div class="label">Temp</div>
                      <div class="value" id="hpTemp">--</div>
                    </div>
                  </div>
                </section>

                <section class="panel">
                  <h2>Attacks</h2>
                  <div id="attacksBlock"></div>
                </section>

                <div class="panel-row">
                  <section class="panel">
                    <h2>Proficiencies & Languages</h2>
                    <div class="list" id="profsList"></div>
                  </section>

                  <section class="panel">
                    <h2>Features</h2>
                    <div class="list" id="featuresList"></div>
                  </section>
                </div>
              </div>

              <div class="col">
                <section class="panel">
                  <h2>Appearance</h2>
                  <div class="portrait-frame">
                    <div class="portrait-visual" id="portraitVisual">
                      <div id="portraitSlot" class="portrait-placeholder">Portrait</div>
                    </div>
                    <div class="list" id="appearanceList"></div>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </details>

        <details class="section">
          <summary>Equipment & Treasure</summary>
          <div class="section-body">
            <div class="equipment-grid">
              <div class="equip-col">
                <section class="subsection">
                  <h3>Gear</h3>
                  <div class="list" id="equipmentGear"></div>
                </section>
                <section class="subsection">
                  <h3>Weapons</h3>
                  <div class="list" id="equipmentWeapons"></div>
                </section>
              </div>

              <div class="equip-col">
                <section class="subsection">
                  <h3>Potions</h3>
                  <div class="list" id="equipmentPotions"></div>
                </section>
                <section class="subsection">
                  <h3>Scrolls</h3>
                  <div class="list" id="equipmentScrolls"></div>
                </section>
                <section class="subsection">
                  <h3>Supplies</h3>
                  <div class="list" id="equipmentSupplies"></div>
                </section>
              </div>

              <div class="equip-col">
                <section class="subsection">
                  <h3>Treasure</h3>
                  <div id="treasureTable"></div>
                </section>
              </div>
            </div>
          </div>
        </details>

        <details class="section">
          <summary>Spells</summary>
          <div class="section-body">
            <section class="panel">
              <h2>Known & Prepared</h2>
              <div class="spells-columns" id="spellsBlock"></div>
            </section>
          </div>
        </details>

        <details class="section">
          <summary>Personality</summary>
          <div class="section-body">
            <div class="section-grid">
              <section class="panel">
                <h2>Traits / Ideals / Bonds / Flaws</h2>
                <div class="list" id="personalityList"></div>
              </section>

              <section class="panel">
                <h2>Notes</h2>
                <pre id="notesText" class="empty">No notes</pre>
              </section>
            </div>
          </div>
        </details>

        <details class="section">
          <summary>History</summary>
          <div class="section-body">
            <section class="panel">
              <h2>Adventure History</h2>
              <div class="list" id="historyList"></div>
            </section>
          </div>
        </details>
      </section>

    </main>
  </div>

  <script>
    const elSheet = document.getElementById('sheet');
    const elStatus = document.getElementById('status');
    const elStatusMsg = document.getElementById('statusMsg');
    const elBackLink = document.getElementById('backLink');

    const els = {
      name: document.getElementById('charName'),
      meta: document.getElementById('charMeta'),
      fieldClassLevel: document.getElementById('fieldClassLevel'),
      fieldBackground: document.getElementById('fieldBackground'),
      fieldRace: document.getElementById('fieldRace'),
      fieldAlignment: document.getElementById('fieldAlignment'),
      fieldXp: document.getElementById('fieldXp'),
      abilityList: document.getElementById('abilityList'),
      savesList: document.getElementById('savesList'),
      skillsList: document.getElementById('skillsList'),
      profsList: document.getElementById('profsList'),
      passiveValue: document.getElementById('passiveValue'),
      combatGrid: document.getElementById('combatGrid'),
      hpMax: document.getElementById('hpMax'),
      hpCurrent: document.getElementById('hpCurrent'),
      hpTemp: document.getElementById('hpTemp'),
      attacksBlock: document.getElementById('attacksBlock'),
      featuresList: document.getElementById('featuresList'),
      equipmentGear: document.getElementById('equipmentGear'),
      equipmentWeapons: document.getElementById('equipmentWeapons'),
      equipmentPotions: document.getElementById('equipmentPotions'),
      equipmentScrolls: document.getElementById('equipmentScrolls'),
      equipmentSupplies: document.getElementById('equipmentSupplies'),
      portraitSlot: document.getElementById('portraitSlot'),
      portraitVisual: document.getElementById('portraitVisual'),
      appearanceList: document.getElementById('appearanceList'),
      spellsBlock: document.getElementById('spellsBlock'),
      treasureTable: document.getElementById('treasureTable'),
      personalityList: document.getElementById('personalityList'),
      historyList: document.getElementById('historyList'),
      notesText: document.getElementById('notesText')
    };

    function setStatus(msg, isError) {
      if (!elStatusMsg) return;
      elStatusMsg.textContent = msg;
      elStatusMsg.style.background = isError ? 'rgba(179, 60, 60, 0.5)' : 'rgba(0,0,0,0.35)';
    }

    function parseSheet(raw) {
      if (!raw) return {};
      if (typeof raw === 'object') return raw;
      if (typeof raw === 'string') {
        try { return JSON.parse(raw); } catch { return {}; }
      }
      return {};
    }

    function abilityMod(score) {
      if (!Number.isFinite(score)) return 0;
      return Math.floor((score - 10) / 2);
    }

    function formatMod(val) {
      if (!Number.isFinite(val)) return '--';
      return (val >= 0 ? '+' : '') + val;
    }

    function renderAbilities(abilities) {
      const order = [
        ['str', 'STR'], ['dex', 'DEX'], ['con', 'CON'],
        ['int', 'INT'], ['wis', 'WIS'], ['cha', 'CHA'],
      ];
      els.abilityList.innerHTML = '';
      for (const [key, label] of order) {
        const raw = abilities && abilities[key];
        const score = Number.isFinite(Number(raw)) ? Number(raw) : null;
        const mod = score != null ? abilityMod(score) : null;
        const row = document.createElement('div');
        row.className = 'ability';
        row.innerHTML =
          '<div>' +
            '<div class="label">' + label + '</div>' +
            '<div class="score">' + (score != null ? score : '--') + '</div>' +
          '</div>' +
          '<div class="mod">' + (mod != null ? formatMod(mod) : '--') + '</div>';
        els.abilityList.appendChild(row);
      }
    }

    function renderList(el, items, emptyLabel) {
      el.innerHTML = '';
      const list = Array.isArray(items) ? items : [];
      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      for (const item of list) {
        const line = document.createElement('div');
        if (item && typeof item === 'object' && item.name != null) {
          const name = String(item.name);
          const qtyRaw = item.qty != null ? item.qty : item.quantity;
          const qty = Number.isFinite(Number(qtyRaw)) ? Number(qtyRaw) : null;
          line.textContent = qty && qty !== 1 ? (name + ' x' + qty) : name;
        } else {
          line.textContent = String(item);
        }
        el.appendChild(line);
      }
    }

    function renderKeyValueList(el, obj, labels, emptyLabel) {
      el.innerHTML = '';
      if (!obj || typeof obj !== 'object') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      const entries = Object.entries(obj);
      if (!entries.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      entries.forEach(([key, val]) => {
        const line = document.createElement('div');
        const name = labels && labels[key] ? labels[key] : key;
        line.textContent = name + ': ' + String(val);
        el.appendChild(line);
      });
    }

    function renderCombatMini(combat, passive) {
      const boxes = [
        { label: 'Armor Class', value: combat.ac != null ? combat.ac : '--' },
        { label: 'Initiative', value: combat.initiative_mod != null ? formatMod(Number(combat.initiative_mod)) : '--' },
        { label: 'Speed', value: combat.speed_ft != null ? combat.speed_ft + ' ft' : '--' }
      ];
      els.combatGrid.innerHTML = boxes.map(b =>
        '<div class="mini-box"><div class="label">' + b.label + '</div><div class="value">' + b.value + '</div></div>'
      ).join('');
      els.passiveValue.textContent = passive;
    }

    function renderHp(combat) {
      const maxHp = combat.max_hp != null ? combat.max_hp : '--';
      const currentHp = combat.current_hp != null ? combat.current_hp : (combat.hp != null ? combat.hp : '--');
      const tempHp = combat.temp_hp != null ? combat.temp_hp : (combat.temp != null ? combat.temp : '--');
      els.hpMax.textContent = maxHp;
      els.hpCurrent.textContent = currentHp;
      els.hpTemp.textContent = tempHp;
    }

    function renderAttacks(attacks) {
      if (!Array.isArray(attacks) || !attacks.length) {
        els.attacksBlock.innerHTML = '<div class="empty">No attacks listed.</div>';
        return;
      }
      const rows = attacks.map((a) => {
        const name = a && a.name ? a.name : 'Attack';
        const toHit = a && (a.to_hit != null ? a.to_hit : a.toHit != null ? a.toHit : '');
        const damage = a && (a.damage != null ? a.damage : a.dmg != null ? a.dmg : '');
        return '<tr><td>' + name + '</td><td>' + toHit + '</td><td>' + damage + '</td></tr>';
      }).join('');
      els.attacksBlock.innerHTML =
        '<table><thead><tr><th>Name</th><th>To Hit</th><th>Damage/Type</th></tr></thead><tbody>' +
        rows +
        '</tbody></table>';
    }

    function normalizeSpellEntries(spells) {
      if (!spells || typeof spells !== 'object') return [];
      const entries = Array.isArray(spells.entries) ? spells.entries : [];
      if (entries.length) return entries;

      const known = Array.isArray(spells.known) ? spells.known : [];
      const prepared = new Set(Array.isArray(spells.prepared) ? spells.prepared : []);
      return known.map((name) => ({
        name,
        level: null,
        tags: [],
        prepared: prepared.has(name)
      }));
    }

    function spellGroupFor(tags) {
      const list = Array.isArray(tags) ? tags : [tags];
      const norm = list.map(t => String(t || '').toLowerCase());
      if (norm.includes('offense') || norm.includes('offensive') || norm.includes('damage')) return 'offense';
      if (norm.includes('defense') || norm.includes('defensive') || norm.includes('protection')) return 'defense';
      if (norm.includes('utility') || norm.includes('support') || norm.includes('control')) return 'utility';
      return 'utility';
    }

    function renderSpells(spells) {
      const entries = normalizeSpellEntries(spells);
      if (!entries.length) {
        els.spellsBlock.innerHTML = '<div class="empty">No spells listed.</div>';
        return;
      }

      const groups = { offense: [], defense: [], utility: [] };
      for (const raw of entries) {
        if (!raw) continue;
        const name = raw.name != null ? String(raw.name) : '';
        if (!name) continue;
        const level = Number.isFinite(Number(raw.level)) ? Number(raw.level) : null;
        const prepared = !!raw.prepared;
        const tags = raw.tags || raw.tag || raw.type || [];
        const group = spellGroupFor(tags);
        groups[group].push({ name, level, prepared });
      }

      const sortSpells = (a, b) => {
        const la = (a.level == null) ? -1 : a.level;
        const lb = (b.level == null) ? -1 : b.level;
        if (lb !== la) return lb - la;
        return a.name.localeCompare(b.name);
      };

      const renderGroup = (title, list) => {
        const sorted = list.slice().sort(sortSpells);
        const items = sorted.map((s) => {
          const levelText = (s.level == null) ? '' : ('L' + s.level);
          const prepared = s.prepared ? '✅' : '';
          return '<div class="spell-item"><span class="spell-level">' + levelText + '</span><span>' + s.name + '</span><span style="margin-left:auto;">' + prepared + '</span></div>';
        }).join('');
        const body = items || '<div class="empty">None</div>';
        return '<div class="spell-group"><h3>' + title + '</h3><div class="spell-list">' + body + '</div></div>';
      };

      els.spellsBlock.innerHTML =
        renderGroup('Offense', groups.offense) +
        renderGroup('Defense', groups.defense) +
        renderGroup('Utility', groups.utility);
    }

    function renderPortrait(appearance) {
      const url = appearance && appearance.portrait_url ? String(appearance.portrait_url) : '';
      if (!url) return;
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Portrait';
      if (els.portraitSlot && els.portraitSlot.parentElement) {
        els.portraitSlot.parentElement.replaceChild(img, els.portraitSlot);
        els.portraitSlot = img;
      }
    }

    function normalizeCategory(cat) {
      const name = String(cat || '').toLowerCase();
      if (!name) return null;
      if (name.includes('weapon')) return 'weapons';
      if (name.includes('potion') || name.includes('elixir')) return 'potions';
      if (name.includes('scroll')) return 'scrolls';
      if (name.includes('supply') || name.includes('kit')) return 'supplies';
      if (name.includes('gear') || name.includes('equipped') || name.includes('armor') || name.includes('worn')) return 'gear';
      return null;
    }

    function inferCategoryFromName(name) {
      const lowered = String(name || '').toLowerCase();
      if (!lowered) return 'gear';
      if (['sword', 'dagger', 'axe', 'bow', 'crossbow', 'staff', 'mace', 'spear', 'hammer', 'wand'].some(w => lowered.includes(w))) {
        return 'weapons';
      }
      if (['potion', 'elixir', 'vial'].some(w => lowered.includes(w))) return 'potions';
      if (['scroll'].some(w => lowered.includes(w))) return 'scrolls';
      if (['rations', 'rope', 'torch', 'tinder', 'kit', 'pack', 'bedroll', 'tools', 'supplies'].some(w => lowered.includes(w))) {
        return 'supplies';
      }
      return 'gear';
    }

    function toNumber(value) {
      if (typeof value === 'number' && Number.isFinite(value)) return value;
      if (typeof value === 'string') {
        const trimmed = value.replace(/,/g, '').trim();
        if (!trimmed) return null;
        const parsed = Number(trimmed);
        return Number.isFinite(parsed) ? parsed : null;
      }
      return null;
    }

    function formatGp(value) {
      if (!Number.isFinite(value)) return '--';
      const rounded = Math.round(value * 100) / 100;
      return Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(2);
    }

    function renderTreasureTable(treasure, currency) {
      const rows = [];
      let total = 0;

      const addRow = (name, qty, valueGp) => {
        const qtyVal = Number.isFinite(Number(qty)) ? Number(qty) : '';
        const valueText = Number.isFinite(valueGp) ? formatGp(valueGp) : '--';
        rows.push({ name, qty: qtyVal, value: valueText });
        if (Number.isFinite(valueGp)) total += valueGp;
      };

      const rates = { pp: 10, gp: 1, sp: 0.1, cp: 0.01, ep: 0.5 };
      if (currency && typeof currency === 'object') {
        Object.entries(currency).forEach(([key, raw]) => {
          const qty = toNumber(raw);
          if (!Number.isFinite(qty) || qty === 0) return;
          const unit = rates[key.toLowerCase()];
          const valueGp = Number.isFinite(unit) ? qty * unit : null;
          addRow(key.toUpperCase(), qty, valueGp);
        });
      }

      const list = Array.isArray(treasure) ? treasure : [];
      for (const item of list) {
        if (!item) continue;
        if (typeof item === 'string') {
          addRow(item, 1, null);
          continue;
        }
        const name = item.name != null ? String(item.name) : 'Item';
        const qty = toNumber(item.qty != null ? item.qty : item.quantity) || 1;
        const each = toNumber(item.value_each_gp != null ? item.value_each_gp : item.value_each);
        let valueGp = null;
        if (Number.isFinite(each)) {
          valueGp = each * qty;
        } else {
          valueGp = toNumber(item.value_gp != null ? item.value_gp : (item.gp_value != null ? item.gp_value : item.value));
        }
        addRow(name, qty, valueGp);
      }

      if (!rows.length) {
        els.treasureTable.innerHTML = '<div class="empty">No treasure listed.</div>';
        return;
      }

      const body = rows.map((row) =>
        '<tr><td>' + row.name + '</td><td>' + row.qty + '</td><td>' + row.value + '</td></tr>'
      ).join('');
      const totalRow = '<tr><td style="font-weight:600;">Total</td><td></td><td style="font-weight:600;">' + formatGp(total) + '</td></tr>';
      els.treasureTable.innerHTML =
        '<table class="treasure-table">' +
          '<thead><tr><th>Item</th><th>Qty</th><th>Gold Value</th></tr></thead>' +
          '<tbody>' + body + totalRow + '</tbody>' +
        '</table>';
    }

    function renderSheet(character) {
      const sheet = parseSheet(character.sheet_json);
      const identity = sheet.identity || {};
      const appearance = sheet.appearance || {};
      const personality = sheet.personality || {};

      const name = identity.name || character.name || 'Unknown';
      const klass = identity.class || identity.class_name || '';
      const level = identity.level != null ? identity.level : '';
      const race = identity.race || '';
      const background = identity.background || '';
      const alignment = identity.alignment || '';
      const xp = identity.experience_points || identity.xp || '';

      document.title = name + ' - Character Sheet';
      els.name.textContent = name;
      els.meta.textContent = '';
      els.meta.style.display = 'none';

      const classLevel = klass && level ? (klass + ' ' + level) : (klass || level || '--');
      els.fieldClassLevel.textContent = classLevel || '--';
      els.fieldBackground.textContent = background || '--';
      els.fieldRace.textContent = race || '--';
      els.fieldAlignment.textContent = alignment || '--';
      els.fieldXp.textContent = xp || '--';

      renderAbilities(sheet.abilities || {});

      const combat = sheet.combat || {};
      const passivePerception = (sheet.skills && Number.isFinite(Number(sheet.skills.perception)))
        ? 10 + Number(sheet.skills.perception)
        : '--';
      renderCombatMini(combat, passivePerception);
      renderHp(combat);

      renderPortrait(appearance);

      const appearanceFields = [
        ['Age', appearance.age],
        ['Height', appearance.height],
        ['Weight', appearance.weight],
        ['Eyes', appearance.eyes],
        ['Skin', appearance.skin],
        ['Hair', appearance.hair]
      ].filter(([, v]) => v != null && v !== '');
      if (appearanceFields.length) {
        els.appearanceList.innerHTML = appearanceFields
          .map(([k, v]) => '<div>' + k + ': ' + v + '</div>')
          .join('');
        els.appearanceList.style.display = 'flex';
      } else {
        els.appearanceList.innerHTML = '';
        els.appearanceList.style.display = 'none';
      }

      renderKeyValueList(els.savesList, sheet.saves, {
        str: 'STR', dex: 'DEX', con: 'CON', int: 'INT', wis: 'WIS', cha: 'CHA'
      }, 'No saves listed.');
      renderKeyValueList(els.skillsList, sheet.skills, null, 'No skills listed.');

      const profs = sheet.proficiencies || {};
      const profLines = [];
      if (Array.isArray(profs.armor) && profs.armor.length) profLines.push('Armor: ' + profs.armor.join(', '));
      if (Array.isArray(profs.weapons) && profs.weapons.length) profLines.push('Weapons: ' + profs.weapons.join(', '));
      if (Array.isArray(profs.tools) && profs.tools.length) profLines.push('Tools: ' + profs.tools.join(', '));
      if (Array.isArray(profs.languages) && profs.languages.length) profLines.push('Languages: ' + profs.languages.join(', '));
      renderList(els.profsList, profLines, 'No proficiencies listed.');

      renderAttacks(sheet.attacks);
      renderList(els.featuresList, sheet.features, 'No features listed.');
      const equipment = Array.isArray(sheet.equipment) ? sheet.equipment : (Array.isArray(sheet.inventory) ? sheet.inventory : []);
      const buckets = { gear: [], weapons: [], potions: [], scrolls: [], supplies: [] };

      for (const raw of equipment) {
        const name = (raw && typeof raw === 'object' && raw.name != null) ? raw.name : raw;
        const nameText = String(name || '');
        if (!nameText) continue;
        const cat = raw && typeof raw === 'object' ? normalizeCategory(raw.category) : null;
        const bucket = cat || inferCategoryFromName(nameText);
        (buckets[bucket] || buckets.gear).push(raw);
      }

      renderList(els.equipmentGear, buckets.gear, 'None');
      renderList(els.equipmentWeapons, buckets.weapons, 'None');
      renderList(els.equipmentPotions, buckets.potions, 'None');
      renderList(els.equipmentScrolls, buckets.scrolls, 'None');
      renderList(els.equipmentSupplies, buckets.supplies, 'None');

      renderSpells(sheet.spells);
      renderTreasureTable(sheet.treasure, sheet.currency);

      const personalityLines = [];
      if (personality.traits) personalityLines.push('Traits: ' + personality.traits);
      if (personality.ideals) personalityLines.push('Ideals: ' + personality.ideals);
      if (personality.bonds) personalityLines.push('Bonds: ' + personality.bonds);
      if (personality.flaws) personalityLines.push('Flaws: ' + personality.flaws);
      renderList(els.personalityList, personalityLines, 'No personality notes.');

      const history = Array.isArray(sheet.adventure_history) ? sheet.adventure_history : [];
      const historyLines = history.map(h => {
        if (h && typeof h === 'object') {
          const date = h.date ? String(h.date) + ': ' : '';
          return date + (h.summary ? String(h.summary) : JSON.stringify(h));
        }
        return String(h);
      });
      renderList(els.historyList, historyLines, 'No history yet.');

      const notes = character.notes_text ? String(character.notes_text) : '';
      if (notes) {
        els.notesText.textContent = notes;
        els.notesText.classList.remove('empty');
      } else {
        els.notesText.textContent = 'No notes';
        els.notesText.classList.add('empty');
      }
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      const characterId = params.get('character_id') || params.get('characterId') || params.get('id');
      const battleId = params.get('battle_id') || params.get('battleId') || params.get('battle');
      if (battleId && elBackLink) {
        elBackLink.href = '/app/battlemat.html?battle_id=' + encodeURIComponent(battleId);
      }
      if (!characterId) {
        setStatus('Missing character_id in URL.', true);
        return;
      }

      try {
        const res = await fetch('/api/characters/' + encodeURIComponent(characterId), {
          method: 'GET',
          cache: 'no-store',
          headers: { 'Accept': 'application/json' },
        });
        if (!res.ok) {
          setStatus('Failed to load character (' + res.status + ').', true);
          return;
        }
        const data = await res.json();
        renderSheet(data || {});
        if (elStatus) elStatus.hidden = true;
        if (elSheet) elSheet.hidden = false;
      } catch (e) {
        setStatus('Failed to load character.', true);
      }
    }

    init();
  </script>
</body>
</html>
