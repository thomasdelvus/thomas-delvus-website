<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Sheet</title>
  <style>
    :root{
      --bg-deep:#0d1016;
      --bg-mid:#1a1f2a;
      --ink:#2b2416;
      --muted:#6a5c45;
      --accent:#b57a2c;
      --accent-2:#2c6fb5;
      --paper:#f1e4c7;
      --paper-2:#f7eed6;
      --paper-edge:#c8b08a;
      --panel:#f9f1dc;
      --shadow:rgba(0,0,0,0.22);
    }
    html,body{height:100%;margin:0;}
    body{
      font-family:"Garamond","Book Antiqua","Palatino Linotype",serif;
      background:
        radial-gradient(1200px 600px at 12% -10%, #1f2532 0%, rgba(31,37,50,0) 60%),
        radial-gradient(900px 500px at 110% 10%, #202632 0%, rgba(32,38,50,0) 65%),
        linear-gradient(180deg, var(--bg-deep), var(--bg-mid));
      color:var(--ink);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px 0;
      color:#e8edf7;
    }
    .brand{
      font-family:"Copperplate Gothic","Garamond","Book Antiqua",serif;
      letter-spacing:0.12em;
      text-transform:uppercase;
      font-size:12px;
      opacity:0.8;
    }
    .nav a{
      color:#e8edf7;
      text-decoration:none;
      border:1px solid rgba(255,255,255,0.22);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .nav a:hover{background:rgba(255,255,255,0.08);}
    .wrap{
      max-width:1180px;
      margin:18px auto 48px;
      padding:0 18px;
    }
    .sheet{
      background:
        url('/assets/sprites/parchment.png') center/cover no-repeat,
        linear-gradient(180deg, var(--paper-2), var(--paper));
      border:1px solid var(--paper-edge);
      border-radius:22px;
      box-shadow:0 18px 40px var(--shadow);
      padding:22px 22px 28px;
      position:relative;
      overflow:hidden;
    }
    .sheet:before{
      content:"";
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,0.02) 0px, rgba(0,0,0,0.02) 1px, transparent 1px, transparent 3px),
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0) 45%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0) 40%);
      opacity:0.45;
      pointer-events:none;
    }
    .sheet > *{position:relative;}
    .sheet-page{display:flex;flex-direction:column;gap:14px;animation:fadeIn 0.6s ease both;}
    .page-label{
      font-size:11px;
      letter-spacing:0.2em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .sheet-header{
      display:grid;
      grid-template-columns:1.2fr 1.8fr;
      gap:14px;
      align-items:end;
    }
    .name-block h1{
      margin:0;
      font-size:34px;
      letter-spacing:0.02em;
      font-family:"Copperplate Gothic","Garamond","Book Antiqua",serif;
    }
    .name-block .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }
    .header-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px 10px;
    }
    .header-field{
      border:1px solid rgba(47,35,20,0.25);
      border-radius:10px;
      padding:6px 8px;
      background:rgba(249,241,220,0.8);
    }
    .header-field .label{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .header-field .value{font-size:14px;margin-top:4px;font-weight:600;}

    .sheet-grid{
      display:grid;
      grid-template-columns:110px 0.45fr 1.35fr 0.9fr;
      gap:12px;
    }
    .col{display:flex;flex-direction:column;gap:12px;min-width:0;min-height:0;}

    .panel{
      position:relative;
      border:1px solid rgba(47,35,20,0.28);
      border-radius:16px;
      background:rgba(249,241,220,0.95);
      padding:12px;
      box-shadow:0 6px 12px rgba(0,0,0,0.12);
    }
    .panel:before{
      content:"";
      position:absolute;
      inset:6px;
      border:1px solid rgba(47,35,20,0.18);
      border-radius:12px;
      pointer-events:none;
    }
    .panel h2{
      margin:0 0 8px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .panel-row{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }

    .ability-list{display:flex;flex-direction:column;gap:8px;}
    .ability{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      padding:6px 8px;
      border:1px dashed rgba(0,0,0,0.25);
      border-radius:12px;
      background:#fff8e7;
    }
    .ability .score{font-size:18px;font-weight:700;}
    .ability .label{font-size:11px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .ability .mod{font-size:12px;color:var(--accent-2);font-weight:700;}

    .mini-grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:8px;}
    .mini-box{
      border:1px solid rgba(0,0,0,0.15);
      border-radius:12px;
      padding:8px;
      text-align:center;
      background:#fff8e7;
    }
    .mini-box .label{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .mini-box .value{font-size:16px;font-weight:700;margin-top:6px;}
    #passiveBox .label{display:none;}
    #passiveBox .value{margin-top:0;}

    .hp-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px;
      text-align:center;
    }
    .hp-grid .box{
      border:1px solid rgba(0,0,0,0.15);
      border-radius:10px;
      background:#fff8e7;
      padding:8px 6px;
    }
    .hp-grid .label{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .hp-grid .value{font-size:16px;font-weight:700;margin-top:6px;}

    .list{display:flex;flex-direction:column;gap:6px;font-size:14px;}
    .pill-list{display:flex;flex-wrap:wrap;gap:6px;}
    .pill{display:inline-flex;padding:4px 10px;border-radius:999px;background:#efe2c6;border:1px solid rgba(0,0,0,0.15);font-size:12px;}

    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:6px 6px;border-bottom:1px solid rgba(0,0,0,0.1);text-align:left;}
    th{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}

    .portrait-frame{display:flex;flex-direction:column;gap:10px;}
    .portrait-visual{
      width:100%;
      aspect-ratio:3 / 4;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.12);
      overflow:hidden;
      background:#e6dcc3;
    }
    .portrait-visual img{width:100%;height:100%;object-fit:cover;display:block;}
    .portrait-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:0.12em;background:#f6ecd4;}

    .spells-columns{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

    .treasure-grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:6px 10px;font-size:13px;}
    .treasure-grid div:nth-child(odd){color:var(--muted);}

    .page-two-grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:14px;}

    pre{margin:0;white-space:pre-wrap;font-family:"Courier New",Courier,monospace;background:#f4e8cf;border:1px solid rgba(0,0,0,0.12);border-radius:12px;padding:12px;}
    .empty{color:var(--muted);font-style:italic;}

    .status{text-align:center;color:#e8edf7;padding:30px 10px;font-size:16px;}
    .status .msg{display:inline-block;padding:12px 18px;border-radius:12px;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.18);}

    @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

    @media (max-width: 1200px){
      .sheet-header{grid-template-columns:1fr;}
      .header-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
      .sheet-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 820px){
      .sheet-grid{grid-template-columns:1fr;}
      .panel-row{grid-template-columns:1fr;}
    }
    @media (max-width: 640px){
      .header-grid{grid-template-columns:1fr;}
      .spells-columns{grid-template-columns:1fr;}
      .page-two-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Delvus Character Sheet</div>
    <div class="nav"><a id="backLink" href="/app/battlemat.html">Back to battlemat</a></div>
  </div>

  <div class="wrap">
    <div class="status" id="status"><div class="msg" id="statusMsg">Loading character...</div></div>

    <main class="sheet" id="sheet" hidden>
      <section class="sheet-page">
        <div class="page-label">Page 1</div>

        <header class="sheet-header">
          <div class="name-block">
            <h1 id="charName">Unknown</h1>
            <div class="meta" id="charMeta"></div>
          </div>
          <div class="header-grid">
            <div class="header-field">
              <div class="label">Class & Level</div>
              <div class="value" id="fieldClassLevel">-</div>
            </div>
            <div class="header-field">
              <div class="label">Background</div>
              <div class="value" id="fieldBackground">-</div>
            </div>
            <div class="header-field">
              <div class="label">Player Name</div>
              <div class="value" id="fieldPlayer">-</div>
            </div>
            <div class="header-field">
              <div class="label">Race</div>
              <div class="value" id="fieldRace">-</div>
            </div>
            <div class="header-field">
              <div class="label">Alignment</div>
              <div class="value" id="fieldAlignment">-</div>
            </div>
            <div class="header-field">
              <div class="label">Experience</div>
              <div class="value" id="fieldXp">-</div>
            </div>
          </div>
        </header>

        <div class="sheet-grid">
          <div class="col">
            <section class="panel">
              <h2>Abilities</h2>
              <div class="ability-list" id="abilityList"></div>
            </section>
          </div>

          <div class="col">
            <section class="panel">
              <h2>Saves</h2>
              <div class="list" id="savesList"></div>
            </section>

            <section class="panel">
              <h2>Skills</h2>
              <div class="list" id="skillsList"></div>
            </section>

            <section class="panel">
              <h2>Passive Perception</h2>
              <div class="mini-box" id="passiveBox">
                <div class="label">Passive</div>
                <div class="value" id="passiveValue">--</div>
              </div>
            </section>
          </div>

          <div class="col">
            <section class="panel">
              <h2>Combat</h2>
              <div class="mini-grid" id="combatGrid"></div>
            </section>

            <section class="panel">
              <h2>Hit Points</h2>
              <div class="hp-grid">
                <div class="box">
                  <div class="label">Max</div>
                  <div class="value" id="hpMax">--</div>
                </div>
                <div class="box">
                  <div class="label">Current</div>
                  <div class="value" id="hpCurrent">--</div>
                </div>
                <div class="box">
                  <div class="label">Temp</div>
                  <div class="value" id="hpTemp">--</div>
                </div>
              </div>
            </section>

            <section class="panel">
              <h2>Attacks</h2>
              <div id="attacksBlock"></div>
            </section>

            <div class="panel-row">
              <section class="panel">
                <h2>Proficiencies & Languages</h2>
                <div class="list" id="profsList"></div>
              </section>

              <section class="panel">
                <h2>Features</h2>
                <div class="list" id="featuresList"></div>
              </section>
            </div>

            <section class="panel">
              <h2>Equipment</h2>
              <div class="list" id="equipmentList"></div>
            </section>
          </div>

          <div class="col">
            <section class="panel">
              <h2>Appearance</h2>
              <div class="portrait-frame">
                <div class="portrait-visual" id="portraitVisual">
                  <div id="portraitSlot" class="portrait-placeholder">Portrait</div>
                </div>
                <div class="list" id="appearanceList"></div>
              </div>
            </section>

            <section class="panel">
              <h2>Spells</h2>
              <div class="spells-columns" id="spellsBlock"></div>
            </section>

            <section class="panel">
              <h2>Treasure</h2>
              <div class="treasure-grid" id="treasureGrid"></div>
              <div class="list" id="treasureList"></div>
            </section>
          </div>
        </div>
      </section>

      <section class="sheet-page" style="margin-top:18px;">
        <div class="page-label">Page 2</div>
        <div class="page-two-grid">
          <section class="panel">
            <h2>Personality</h2>
            <div class="list" id="personalityList"></div>
          </section>
          <section class="panel">
            <h2>Adventure History</h2>
            <div class="list" id="historyList"></div>
          </section>
          <section class="panel">
            <h2>Notes</h2>
            <pre id="notesText" class="empty">No notes</pre>
          </section>
        </div>
      </section>
    </main>
  </div>

  <script>
    const elSheet = document.getElementById('sheet');
    const elStatus = document.getElementById('status');
    const elStatusMsg = document.getElementById('statusMsg');
    const elBackLink = document.getElementById('backLink');

    const els = {
      name: document.getElementById('charName'),
      meta: document.getElementById('charMeta'),
      fieldClassLevel: document.getElementById('fieldClassLevel'),
      fieldBackground: document.getElementById('fieldBackground'),
      fieldPlayer: document.getElementById('fieldPlayer'),
      fieldRace: document.getElementById('fieldRace'),
      fieldAlignment: document.getElementById('fieldAlignment'),
      fieldXp: document.getElementById('fieldXp'),
      abilityList: document.getElementById('abilityList'),
      savesList: document.getElementById('savesList'),
      skillsList: document.getElementById('skillsList'),
      profsList: document.getElementById('profsList'),
      passiveValue: document.getElementById('passiveValue'),
      combatGrid: document.getElementById('combatGrid'),
      hpMax: document.getElementById('hpMax'),
      hpCurrent: document.getElementById('hpCurrent'),
      hpTemp: document.getElementById('hpTemp'),
      attacksBlock: document.getElementById('attacksBlock'),
      featuresList: document.getElementById('featuresList'),
      equipmentList: document.getElementById('equipmentList'),
      portraitSlot: document.getElementById('portraitSlot'),
      portraitVisual: document.getElementById('portraitVisual'),
      appearanceList: document.getElementById('appearanceList'),
      spellsBlock: document.getElementById('spellsBlock'),
      treasureGrid: document.getElementById('treasureGrid'),
      treasureList: document.getElementById('treasureList'),
      personalityList: document.getElementById('personalityList'),
      historyList: document.getElementById('historyList'),
      notesText: document.getElementById('notesText')
    };

    function setStatus(msg, isError) {
      if (!elStatusMsg) return;
      elStatusMsg.textContent = msg;
      elStatusMsg.style.background = isError ? 'rgba(179, 60, 60, 0.5)' : 'rgba(0,0,0,0.35)';
    }

    function parseSheet(raw) {
      if (!raw) return {};
      if (typeof raw === 'object') return raw;
      if (typeof raw === 'string') {
        try { return JSON.parse(raw); } catch { return {}; }
      }
      return {};
    }

    function abilityMod(score) {
      if (!Number.isFinite(score)) return 0;
      return Math.floor((score - 10) / 2);
    }

    function formatMod(val) {
      if (!Number.isFinite(val)) return '--';
      return (val >= 0 ? '+' : '') + val;
    }

    function renderAbilities(abilities) {
      const order = [
        ['str', 'STR'], ['dex', 'DEX'], ['con', 'CON'],
        ['int', 'INT'], ['wis', 'WIS'], ['cha', 'CHA'],
      ];
      els.abilityList.innerHTML = '';
      for (const [key, label] of order) {
        const raw = abilities && abilities[key];
        const score = Number.isFinite(Number(raw)) ? Number(raw) : null;
        const mod = score != null ? abilityMod(score) : null;
        const row = document.createElement('div');
        row.className = 'ability';
        row.innerHTML =
          '<div>' +
            '<div class="label">' + label + '</div>' +
            '<div class="score">' + (score != null ? score : '--') + '</div>' +
          '</div>' +
          '<div class="mod">' + (mod != null ? formatMod(mod) : '--') + '</div>';
        els.abilityList.appendChild(row);
      }
    }

    function renderList(el, items, emptyLabel) {
      el.innerHTML = '';
      const list = Array.isArray(items) ? items : [];
      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      for (const item of list) {
        const line = document.createElement('div');
        line.textContent = (item && item.name) ? String(item.name) : String(item);
        el.appendChild(line);
      }
    }

    function renderKeyValueList(el, obj, labels, emptyLabel) {
      el.innerHTML = '';
      if (!obj || typeof obj !== 'object') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      const entries = Object.entries(obj);
      if (!entries.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      entries.forEach(([key, val]) => {
        const line = document.createElement('div');
        const name = labels && labels[key] ? labels[key] : key;
        line.textContent = name + ': ' + String(val);
        el.appendChild(line);
      });
    }

    function renderCombatMini(combat, passive) {
      const boxes = [
        { label: 'Armor Class', value: combat.ac != null ? combat.ac : '--' },
        { label: 'Initiative', value: combat.initiative_mod != null ? formatMod(Number(combat.initiative_mod)) : '--' },
        { label: 'Speed', value: combat.speed_ft != null ? combat.speed_ft + ' ft' : '--' }
      ];
      els.combatGrid.innerHTML = boxes.map(b =>
        '<div class="mini-box"><div class="label">' + b.label + '</div><div class="value">' + b.value + '</div></div>'
      ).join('');
      els.passiveValue.textContent = passive;
    }

    function renderHp(combat) {
      const maxHp = combat.max_hp != null ? combat.max_hp : '--';
      const currentHp = combat.current_hp != null ? combat.current_hp : (combat.hp != null ? combat.hp : '--');
      const tempHp = combat.temp_hp != null ? combat.temp_hp : (combat.temp != null ? combat.temp : '--');
      els.hpMax.textContent = maxHp;
      els.hpCurrent.textContent = currentHp;
      els.hpTemp.textContent = tempHp;
    }

    function renderAttacks(attacks) {
      if (!Array.isArray(attacks) || !attacks.length) {
        els.attacksBlock.innerHTML = '<div class="empty">No attacks listed.</div>';
        return;
      }
      const rows = attacks.map((a) => {
        const name = a && a.name ? a.name : 'Attack';
        const toHit = a && (a.to_hit != null ? a.to_hit : a.toHit != null ? a.toHit : '');
        const damage = a && (a.damage != null ? a.damage : a.dmg != null ? a.dmg : '');
        return '<tr><td>' + name + '</td><td>' + toHit + '</td><td>' + damage + '</td></tr>';
      }).join('');
      els.attacksBlock.innerHTML =
        '<table><thead><tr><th>Name</th><th>To Hit</th><th>Damage/Type</th></tr></thead><tbody>' +
        rows +
        '</tbody></table>';
    }

    function renderSpells(spells) {
      if (!spells || typeof spells !== 'object') {
        els.spellsBlock.innerHTML = '<div class="empty">No spells listed.</div>';
        return;
      }
      const known = Array.isArray(spells.known) ? spells.known : [];
      const prepared = Array.isArray(spells.prepared) ? spells.prepared : [];
      const knownHtml = known.length ? known.map(s => '<div class="pill">' + s + '</div>').join('') : '<div class="empty">None</div>';
      const prepHtml = prepared.length ? prepared.map(s => '<div class="pill">' + s + '</div>').join('') : '<div class="empty">None</div>';
      els.spellsBlock.innerHTML =
        '<div><div class="label" style="font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);">Known</div><div class="pill-list" style="margin-top:6px;">' + knownHtml + '</div></div>' +
        '<div><div class="label" style="font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);">Prepared</div><div class="pill-list" style="margin-top:6px;">' + prepHtml + '</div></div>';
    }

    function renderPortrait(appearance) {
      const url = appearance && appearance.portrait_url ? String(appearance.portrait_url) : '';
      if (!url) return;
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Portrait';
      if (els.portraitSlot && els.portraitSlot.parentElement) {
        els.portraitSlot.parentElement.replaceChild(img, els.portraitSlot);
        els.portraitSlot = img;
      }
    }

    function renderSheet(character) {
      const sheet = parseSheet(character.sheet_json);
      const identity = sheet.identity || {};
      const appearance = sheet.appearance || {};
      const personality = sheet.personality || {};

      const name = identity.name || character.name || 'Unknown';
      const klass = identity.class || identity.class_name || '';
      const level = identity.level != null ? identity.level : '';
      const race = identity.race || '';
      const background = identity.background || '';
      const alignment = identity.alignment || '';
      const player = identity.player_name || '';
      const xp = identity.experience_points || identity.xp || '';

      document.title = name + ' - Character Sheet';
      els.name.textContent = name;
      els.meta.textContent = '';
      els.meta.style.display = 'none';

      const classLevel = klass && level ? (klass + ' ' + level) : (klass || level || '--');
      els.fieldClassLevel.textContent = classLevel || '--';
      els.fieldBackground.textContent = background || '--';
      els.fieldPlayer.textContent = player || '--';
      els.fieldRace.textContent = race || '--';
      els.fieldAlignment.textContent = alignment || '--';
      els.fieldXp.textContent = xp || '--';

      renderAbilities(sheet.abilities || {});

      const combat = sheet.combat || {};
      const passivePerception = (sheet.skills && Number.isFinite(Number(sheet.skills.perception)))
        ? 10 + Number(sheet.skills.perception)
        : '--';
      renderCombatMini(combat, passivePerception);
      renderHp(combat);

      renderPortrait(appearance);

      const appearanceFields = [
        ['Age', appearance.age],
        ['Height', appearance.height],
        ['Weight', appearance.weight],
        ['Eyes', appearance.eyes],
        ['Skin', appearance.skin],
        ['Hair', appearance.hair]
      ].filter(([, v]) => v != null && v !== '');
      if (appearanceFields.length) {
        els.appearanceList.innerHTML = appearanceFields
          .map(([k, v]) => '<div>' + k + ': ' + v + '</div>')
          .join('');
        els.appearanceList.style.display = 'flex';
      } else {
        els.appearanceList.innerHTML = '';
        els.appearanceList.style.display = 'none';
      }

      renderKeyValueList(els.savesList, sheet.saves, {
        str: 'STR', dex: 'DEX', con: 'CON', int: 'INT', wis: 'WIS', cha: 'CHA'
      }, 'No saves listed.');
      renderKeyValueList(els.skillsList, sheet.skills, null, 'No skills listed.');

      const profs = sheet.proficiencies || {};
      const profLines = [];
      if (Array.isArray(profs.armor) && profs.armor.length) profLines.push('Armor: ' + profs.armor.join(', '));
      if (Array.isArray(profs.weapons) && profs.weapons.length) profLines.push('Weapons: ' + profs.weapons.join(', '));
      if (Array.isArray(profs.tools) && profs.tools.length) profLines.push('Tools: ' + profs.tools.join(', '));
      if (Array.isArray(profs.languages) && profs.languages.length) profLines.push('Languages: ' + profs.languages.join(', '));
      renderList(els.profsList, profLines, 'No proficiencies listed.');

      renderAttacks(sheet.attacks);
      renderList(els.featuresList, sheet.features, 'No features listed.');
      renderList(els.equipmentList, sheet.equipment || sheet.inventory, 'No equipment listed.');

      renderSpells(sheet.spells);

      const currency = sheet.currency || {};
      const currencyEntries = Object.entries(currency);
      if (currencyEntries.length) {
        els.treasureGrid.innerHTML = currencyEntries
          .map(([key, val]) => '<div>' + key.toUpperCase() + '</div><div style="text-align:right;">' + val + '</div>')
          .join('');
      } else {
        els.treasureGrid.innerHTML = '<div class="empty">No coin listed.</div>';
      }
      renderList(els.treasureList, sheet.treasure, '');

      const personalityLines = [];
      if (personality.traits) personalityLines.push('Traits: ' + personality.traits);
      if (personality.ideals) personalityLines.push('Ideals: ' + personality.ideals);
      if (personality.bonds) personalityLines.push('Bonds: ' + personality.bonds);
      if (personality.flaws) personalityLines.push('Flaws: ' + personality.flaws);
      renderList(els.personalityList, personalityLines, 'No personality notes.');

      const history = Array.isArray(sheet.adventure_history) ? sheet.adventure_history : [];
      const historyLines = history.map(h => {
        if (h && typeof h === 'object') {
          const date = h.date ? String(h.date) + ': ' : '';
          return date + (h.summary ? String(h.summary) : JSON.stringify(h));
        }
        return String(h);
      });
      renderList(els.historyList, historyLines, 'No history yet.');

      const notes = character.notes_text ? String(character.notes_text) : '';
      if (notes) {
        els.notesText.textContent = notes;
        els.notesText.classList.remove('empty');
      } else {
        els.notesText.textContent = 'No notes';
        els.notesText.classList.add('empty');
      }
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      const characterId = params.get('character_id') || params.get('characterId') || params.get('id');
      const battleId = params.get('battle_id') || params.get('battleId') || params.get('battle');
      if (battleId && elBackLink) {
        elBackLink.href = '/app/battlemat.html?battle_id=' + encodeURIComponent(battleId);
      }
      if (!characterId) {
        setStatus('Missing character_id in URL.', true);
        return;
      }

      try {
        const res = await fetch('/api/characters/' + encodeURIComponent(characterId), {
          method: 'GET',
          cache: 'no-store',
          headers: { 'Accept': 'application/json' },
        });
        if (!res.ok) {
          setStatus('Failed to load character (' + res.status + ').', true);
          return;
        }
        const data = await res.json();
        renderSheet(data || {});
        if (elStatus) elStatus.hidden = true;
        if (elSheet) elSheet.hidden = false;
      } catch (e) {
        setStatus('Failed to load character.', true);
      }
    }

    init();
  </script>
</body>
</html>
