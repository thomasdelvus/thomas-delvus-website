<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Character Sheet</title>
  <style>
    :root{
      --bg-deep:#0d1016;
      --bg-mid:#1a1f2a;
      --ink:#2b2416;
      --muted:#6a5c45;
      --accent:#b57a2c;
      --accent-2:#2c6fb5;
      --paper:#f1e4c7;
      --paper-2:#f7eed6;
      --paper-edge:#c8b08a;
      --panel:#f9f1dc;
      --shadow:rgba(0,0,0,0.22);
      --text-size:15px;
      --save:#5a4b6b;
      --good:#2f6b3a;
    }
    html,body{height:100%;margin:0;}
    body{
      font-family:"Garamond","Book Antiqua","Palatino Linotype",serif;
      background:
        radial-gradient(1200px 600px at 12% -10%, #1f2532 0%, rgba(31,37,50,0) 60%),
        radial-gradient(900px 500px at 110% 10%, #202632 0%, rgba(32,38,50,0) 65%),
        linear-gradient(180deg, var(--bg-deep), var(--bg-mid));
      color:var(--ink);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px 0;
      color:#e8edf7;
    }
    .brand{
      font-family:"Copperplate Gothic","Garamond","Book Antiqua",serif;
      letter-spacing:0.12em;
      text-transform:uppercase;
      font-size:12px;
      opacity:0.8;
    }
    .nav a{
      color:#e8edf7;
      text-decoration:none;
      border:1px solid rgba(255,255,255,0.22);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .nav button{
      color:#e8edf7;
      background:transparent;
      border:1px solid rgba(255,255,255,0.22);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      cursor:pointer;
      font-family:inherit;
    }
    .nav a:hover{background:rgba(255,255,255,0.08);}
    .nav button:hover{background:rgba(255,255,255,0.08);}
    .wrap{
      max-width:1180px;
      margin:18px auto 48px;
      padding:0 18px;
    }
    .sheet{
      background:
        url('/assets/sprites/parchment.png') center/cover no-repeat,
        linear-gradient(180deg, var(--paper-2), var(--paper));
      border:1px solid var(--paper-edge);
      border-radius:22px;
      box-shadow:0 18px 40px var(--shadow);
      padding:22px 22px 28px;
      position:relative;
      overflow:hidden;
    }
    .sheet:before{
      content:"";
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,0.02) 0px, rgba(0,0,0,0.02) 1px, transparent 1px, transparent 3px),
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0) 45%),
        radial-gradient(circle at 80% 10%, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0) 40%);
      opacity:0.45;
      pointer-events:none;
    }
    .sheet > *{position:relative;}
    .sheet-page{display:flex;flex-direction:column;gap:14px;animation:fadeIn 0.6s ease both;}
    .section{
      border:1px solid rgba(47,35,20,0.3);
      border-radius:18px;
      background:rgba(249,241,220,0.65);
      box-shadow:0 8px 18px rgba(0,0,0,0.12);
      overflow:hidden;
    }
    .section > summary{
      list-style:none;
      cursor:pointer;
      padding:10px 14px;
      font-size:12px;
      letter-spacing:0.22em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:12px;
      background:rgba(249,241,220,0.9);
      border-bottom:1px solid rgba(47,35,20,0.2);
    }
    .section > summary::-webkit-details-marker{display:none;}
    .section > summary::after{
      content:"▾";
      margin-left:auto;
      font-size:12px;
      color:rgba(47,35,20,0.6);
    }
    .section[open] > summary::after{content:"▴";}
    .section-body{padding:12px;}
    .section-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .section-stack{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .equipment-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:12px;
    }
    .equip-col{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .treasure-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    .treasure-table th,
    .treasure-table td{
      padding:6px 6px;
      border-bottom:1px solid rgba(0,0,0,0.1);
      text-align:left;
    }
    .treasure-table th:nth-child(2),
    .treasure-table td:nth-child(2),
    .treasure-table th:nth-child(3),
    .treasure-table td:nth-child(3){
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    .treasure-table th{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .sheet-header{
      display:grid;
      grid-template-columns:1.2fr 1.8fr;
      gap:14px;
      align-items:start;
    }
    .name-block h1{
      margin:0;
      font-size:34px;
      letter-spacing:0.02em;
      font-family:"Copperplate Gothic","Garamond","Book Antiqua",serif;
    }
    .name-block .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }
    .header-grid{
      display:grid;
      grid-template-columns:repeat(5, minmax(0,1fr));
      gap:8px 10px;
    }
    .header-field{
      border:1px solid rgba(47,35,20,0.25);
      border-radius:10px;
      padding:6px 8px;
      background:rgba(249,241,220,0.8);
      max-width:170px;
    }
    .header-field .label{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .header-field .value{font-size:14px;margin-top:4px;font-weight:600;}

    .sheet-grid{
      display:grid;
      grid-template-columns:minmax(0, 0.9fr) minmax(0, 0.9fr) minmax(0, 2fr) minmax(0, 1.3fr);
      gap:12px;
      width:100%;
      justify-items:stretch;
      justify-content:stretch;
      align-items:start;
    }
    .sheet-grid-alt{
      grid-template-columns:repeat(4, minmax(0,1fr));
    }
    .col{display:flex;flex-direction:column;gap:12px;min-width:0;min-height:0;}
    .sheet-grid > .col{width:100%;}
    .col-abilities{grid-column:1 / span 2;}

    .panel{
      position:relative;
      min-width:0;
      border:1px solid rgba(47,35,20,0.28);
      border-radius:16px;
      background:rgba(249,241,220,0.95);
      padding:12px;
      box-shadow:0 6px 12px rgba(0,0,0,0.12);
    }
    .panel:before{
      content:"";
      position:absolute;
      inset:6px;
      border:1px solid rgba(47,35,20,0.18);
      border-radius:12px;
      pointer-events:none;
    }
    .panel h2{
      margin:0 0 8px 0;
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .panel-row{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .panel-row.three{
      grid-template-columns:1.3fr 0.8fr 1fr;
    }
    .subsection{
      border:1px solid rgba(47,35,20,0.22);
      border-radius:12px;
      background:rgba(255,250,238,0.7);
      padding:8px 10px 10px;
    }
    .subsection h3{
      margin:0 0 6px 0;
      font-size:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .subsection + .subsection{margin-top:8px;}

    .ability-head{
      display:grid;
      grid-template-columns:1fr 46px 46px;
      align-items:center;
      gap:6px;
      padding:0 8px 6px;
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .ability-head span{text-align:center;}
    .ability-head span:first-child{text-align:left;}
    .ability-list{display:flex;flex-direction:column;gap:8px;}
      .ability{
        display:grid;
        grid-template-columns:1fr 46px 46px;
        align-items:center;
        gap:6px;
        padding:6px 8px;
        border:1px dashed rgba(0,0,0,0.25);
        border-radius:12px;
        background:#fff8e7;
      }
      .ability > div:first-child{
        text-align:center;
        padding-left:2px;
      }
      .ability .score{font-size:20px;font-weight:700;}
      .ability .label{font-size:12px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .ability .mod,
    .ability .save{
      min-width:36px;
      text-align:center;
      font-size:12px;
      font-weight:700;
      color:var(--save);
      border:1px dashed rgba(0,0,0,0.22);
      border-radius:10px;
      padding:4px 6px;
      background:#fff8e7;
    }
    .ability .mod{color:var(--good);}

    .mini-grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:8px;}
    .mini-box{
      border:1px solid rgba(0,0,0,0.15);
      border-radius:12px;
      padding:6px;
      text-align:center;
      background:#fff8e7;
    }
    .mini-box .label{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .mini-box .value{font-size:16px;font-weight:700;margin-top:6px;}
    #passiveBox .label{display:none;}
    #passiveBox .value{margin-top:0;}

    .passive-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .passive-item{
      display:grid;
      grid-template-columns:52px 1fr;
      align-items:center;
      gap:10px;
      padding:6px 8px;
      border:1px dashed rgba(0,0,0,0.2);
      border-radius:12px;
      background:#fff8e7;
    }
    .passive-item .value{
      font-size:16px;
      font-weight:700;
      color:var(--ink);
      border:none;
      border-radius:10px;
      padding:4px 6px;
      text-align:center;
      background:transparent;
    }
    .passive-item .label{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
    }

    .hp-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px;
      text-align:center;
    }
    .hp-grid .box{
      border:1px solid rgba(0,0,0,0.15);
      border-radius:10px;
      background:#fff8e7;
      padding:6px;
    }
    .hp-grid .label{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .hp-grid .value{font-size:16px;font-weight:700;margin-top:6px;}

    .list{display:flex;flex-direction:column;gap:6px;font-size:var(--text-size);}
    #appearanceList{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:4px 12px;
      padding-left:12px;
      font-size:var(--text-size);
    }
    #profsList > div{
      padding-left:14px;
      text-indent:-14px;
    }
    .pill-list{display:flex;flex-wrap:wrap;gap:6px;}
    .pill{display:inline-flex;padding:4px 10px;border-radius:999px;background:#efe2c6;border:1px solid rgba(0,0,0,0.15);font-size:12px;}

    table{width:100%;border-collapse:collapse;font-size:var(--text-size);}
    th,td{padding:6px 6px;border-bottom:1px solid rgba(0,0,0,0.1);text-align:left;}
    th{font-size:10px;letter-spacing:0.16em;text-transform:uppercase;color:var(--muted);}
    .kv-table{width:100%;border-collapse:collapse;font-size:var(--text-size);}
    .kv-table td{padding:2px 4px;border-bottom:none;vertical-align:top;}
    .kv-table td:first-child{width:20%;white-space:nowrap;color:var(--muted);font-weight:600;}

    .portrait-frame{display:flex;flex-direction:column;gap:10px;}
    .portrait-visual{
      width:100%;
      aspect-ratio:3 / 4;
      min-width:0;
      max-width:100%;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.12);
      overflow:hidden;
      background:#e6dcc3;
    }
    .portrait-visual img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:50% 15%;
      display:block;
    }
    .portrait-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:0.12em;background:#f6ecd4;}

    .spells-columns{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:10px;}
    .spell-group{display:flex;flex-direction:column;gap:6px;}
    .spell-group h3{
      margin:0;
      font-size:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .spell-header{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .spell-field{
      border:1px solid rgba(0,0,0,0.15);
      border-radius:12px;
      padding:8px;
      text-align:center;
      background:#fff8e7;
    }
    .spell-field .label{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .spell-field .value{
      font-size:14px;
      font-weight:700;
      margin-top:6px;
    }
    .personality-grid{
      display:grid;
      grid-template-columns:0.9fr 1.1fr;
      gap:12px;
    }
    .personality-stack{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .personality-bubble{
      display:grid;
      grid-template-columns:90px 1fr;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border:1px dashed rgba(0,0,0,0.2);
      border-radius:12px;
      background:#fff8e7;
    }
    .personality-bubble .label{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
      text-align:center;
    }
    .personality-bubble .value{
      font-size:var(--text-size);
      font-weight:600;
      color:var(--ink);
    }
    .spell-list{display:flex;flex-direction:column;gap:6px;}
    .spell-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:4px 8px;
      border-radius:999px;
      background:#efe2c6;
      border:1px solid rgba(0,0,0,0.12);
      font-size:var(--text-size);
      line-height:1.2;
    }
    .spell-level{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .treasure-grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:6px 10px;font-size:13px;}
    .treasure-grid div:nth-child(odd){color:var(--muted);}

    .page-two-grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:14px;}

    .text-block{
      margin:0;
      white-space:pre-wrap;
      font-family:inherit;
      background:#f4e8cf;
      border:1px solid rgba(0,0,0,0.12);
      border-radius:12px;
      padding:12px;
      font-size:var(--text-size);
    }
    .reputation-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .reputation-table th,
    .reputation-table td{
      padding:6px 6px;
      border-bottom:1px solid rgba(0,0,0,0.1);
      text-align:left;
      vertical-align:top;
    }
    .reputation-table td{font-size:var(--text-size);}
    .treasure-table td{font-size:var(--text-size);}
    .reputation-table th{
      font-size:10px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .empty{color:var(--muted);font-style:italic;}

    .status{text-align:center;color:#e8edf7;padding:30px 10px;font-size:16px;}
    .status .msg{display:inline-block;padding:12px 18px;border-radius:12px;background:rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.18);}

    .sheet-footer{
      margin-top:14px;
      text-align:center;
      font-size:11px;
      color:var(--muted);
      letter-spacing:0.08em;
      text-transform:uppercase;
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}

    @media (max-width: 1200px){
      .sheet-header{grid-template-columns:1fr;}
      .header-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
      .sheet-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
      .spell-header{grid-template-columns:repeat(2, minmax(0,1fr));}
      .personality-grid{grid-template-columns:1fr;}
    }
    @media (max-width: 820px){
      .sheet-grid{grid-template-columns:1fr;}
      .col-abilities{grid-column:auto;}
      .panel-row{grid-template-columns:1fr;}
      .section-grid{grid-template-columns:1fr;}
      .equipment-grid{grid-template-columns:1fr;}
      .spell-header{grid-template-columns:1fr;}
    }
    @media (max-width: 640px){
      .header-grid{grid-template-columns:1fr;}
      .spells-columns{grid-template-columns:1fr;}
      .page-two-grid{grid-template-columns:1fr;}
      .personality-grid{grid-template-columns:1fr;}
    }
    @page{
      size: letter;
      margin: 0.6in 0.35in 0.35in 0.35in;
    }
    @page :first{
      margin: 0.35in;
    }
    @media print{
      :root{
        --text-size:8px;
      }
      html, body{
        width:100%;
        margin:0;
        font-size:9px;
      }
        body{
          background:white;
          -webkit-print-color-adjust:exact;
          print-color-adjust:exact;
        }
        *,
        *::before,
        *::after{
          box-sizing:border-box;
        }
      .topbar,.status{display:none !important;}
      .wrap{max-width:none;margin:0;padding:0;}
        .sheet{
          width:8in;
          margin:0 auto;
          box-shadow:none;
          border:none;
          border-radius:0;
          background:white;
          box-sizing:border-box;
          padding:12px;
          font-size:9px;
        }
        .panel h2{font-size:7px;}
        .name-block h1{font-size:22px;}
        .header-field .value{font-size:8px;}
        .header-field{padding:4px 6px;}
        .header-field .value{margin-top:2px;}
        .section > summary{padding:6px 10px;}
        .section > summary{
          font-size:8px;
          letter-spacing:0.14em;
        }
        .section-body{padding:8px;}
        .equipment-grid{gap:8px;}
        .panel-row{gap:8px;}
        .section{border-radius:14px;}
        .panel{
          padding:8px;
          border-radius:10px;
        }
        .panel:before{
          inset:4px;
          border-radius:8px;
        }
        .panel h2{margin-bottom:6px;}
        .equip-col .panel{margin-top:8px !important;}
        .spell-known{
          border:none;
          box-shadow:none;
          background:transparent;
        }
        .spell-known:before{display:none;}
        .mini-box{padding:2px 3px;}
        .mini-box .value{margin-top:4px;}
        .hp-grid .box{padding:2px 3px;}
        .mini-box{border-radius:8px;}
        .hp-grid .box{border-radius:6px;}
        .subsection{border-radius:8px;}
        .ability .mod,
        .ability .save{
          border-radius:6px;
        }
      .header-field .label,
      .spell-field .label,
      .personality-bubble .label,
      .mini-box .label,
      .hp-grid .label{
        font-size:7px;
      }
        .list,
        table,
        .text-block,
        .reputation-table{
          font-size:6px;
        }
        #skillsFeaturesList,
        #profsList,
        #appearanceList,
        #equipmentGear,
        #equipmentWeapons,
        #equipmentPotions,
        #equipmentScrolls,
        #equipmentSupplies,
        #historyList{
          font-size:8px;
        }
        #attacksBlock table,
        .personality-bubble .value,
        .text-block,
        .reputation-table td{
          font-size:8px;
        }
        .treasure-table td{font-size:8px;}
        th{
          font-size:7px;
          letter-spacing:0.12em;
        }
        .ability .score,
        .mini-box .value,
        .hp-grid .value,
        .passive-item .value,
        .spell-field .value{
          font-size:10px;
        }
        .ability-head{
          grid-template-columns:1fr 34px 34px;
          gap:4px;
        }
        .ability-head span{
          font-size:7px;
          letter-spacing:0.12em;
        }
        .ability{
          grid-template-columns:1fr 34px 34px;
          gap:4px;
          border-radius:8px;
        }
        .ability .label{
          font-size:8px;
          letter-spacing:0.12em;
        }
        .ability .mod,
        .ability .save{
          min-width:24px;
          padding:2px 4px;
          border-radius:4px;
          font-size:8px;
        }
        .passive-item{
          grid-template-columns:32px 1fr;
          gap:4px;
        }
        .passive-item .label{font-size:8px;line-height:1.15;white-space:normal;}
      .sheet-page,
      .section-body,
      .sheet-grid{
        width:100%;
      }
      .sheet:before{display:none;}
      .sheet-header{grid-template-columns:1.2fr 1.8fr;}
      .header-grid{grid-template-columns:repeat(5, minmax(0,1fr));}
      .sheet-grid{
        width:100%;
        grid-template-columns:minmax(0, 0.9fr) minmax(0, 0.9fr) minmax(0, 2fr) minmax(0, 1.3fr);
      }
      .panel-row.three{grid-template-columns:1.3fr 0.8fr 1fr;}
      .equipment-grid{grid-template-columns:repeat(3, minmax(0,1fr));}
      .spells-columns{grid-template-columns:repeat(3, minmax(0,1fr));}
      .spell-header{grid-template-columns:repeat(4, minmax(0,1fr));}
      .personality-grid{grid-template-columns:0.9fr 1.1fr;}
      .panel{overflow:hidden;}
        details.section,
        .section,
        .section-body,
        .panel{
          break-inside:avoid;
          page-break-inside:avoid;
        }
      .section > summary::after{display:none;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Saffrondale Character Sheet</div>
    <div class="nav">
      <a id="backLink" href="/app/battlemat.html">Back to battlemat</a>
      <a id="playerDashLink" href="/app/player.html">Player Dashboard</a>
      <button id="printBtn" type="button">Download PDF</button>
    </div>
  </div>

  <div class="wrap">
    <div class="status" id="status"><div class="msg" id="statusMsg">Loading character...</div></div>

    <main class="sheet" id="sheet" hidden>
      <section class="sheet-page">
        <header class="sheet-header">
          <div class="name-block">
            <h1 id="charName">Unknown</h1>
            <div class="meta" id="charMeta"></div>
          </div>
          <div class="header-grid">
            <div class="header-field">
              <div class="label">Class & Level</div>
              <div class="value" id="fieldClassLevel">-</div>
            </div>
            <div class="header-field">
              <div class="label">Background</div>
              <div class="value" id="fieldBackground">-</div>
            </div>
            <div class="header-field">
              <div class="label">Race</div>
              <div class="value" id="fieldRace">-</div>
            </div>
            <div class="header-field">
              <div class="label">Alignment</div>
              <div class="value" id="fieldAlignment">-</div>
            </div>
            <div class="header-field">
              <div class="label">Experience</div>
              <div class="value" id="fieldXp">-</div>
            </div>
          </div>
        </header>

        <details class="section" open>
          <summary>Base Stats</summary>
          <div class="section-body">
            <div class="equipment-grid" style="grid-template-columns:minmax(0,0.85fr) minmax(0,1.55fr) minmax(0,1.2fr);">
              <div class="equip-col">
                <section class="panel" style="margin-top:12px;">
                  <h2>Abilities</h2>
                  <div class="ability-head">
                    <span></span>
                    <span>Bonus</span>
                    <span>Save</span>
                  </div>
                  <div class="ability-list" id="abilityList"></div>
                </section>
                <section class="panel" style="margin-top:12px;">
                  <h2>Passives</h2>
                  <div class="passive-list">
                    <div class="passive-item">
                      <div class="value" id="passiveValue">--</div>
                      <div class="label">Passive Perception</div>
                    </div>
                    <div class="passive-item">
                      <div class="value" id="proficiencyValue">--</div>
                      <div class="label">Proficiency Bonus</div>
                    </div>
                  </div>
                </section>
              </div>
              <div class="equip-col">
                <section class="panel" style="margin-top:12px;">
                  <h2>Combat</h2>
                  <div class="mini-grid" id="combatGrid"></div>
                </section>
                <section class="panel" style="margin-top:12px;">
                  <h2>Hit Points</h2>
                  <div class="hp-grid">
                    <div class="box">
                      <div class="label">Max</div>
                      <div class="value" id="hpMax">--</div>
                    </div>
                    <div class="box">
                      <div class="label">Current</div>
                      <div class="value" id="hpCurrent">--</div>
                    </div>
                    <div class="box">
                      <div class="label">Temp</div>
                      <div class="value" id="hpTemp">--</div>
                    </div>
                  </div>
                </section>
                <section class="panel" style="margin-top:12px;">
                  <h2>Attacks</h2>
                  <div id="attacksBlock"></div>
                </section>
                <section class="panel" style="margin-top:12px;">
                  <h2>Proficiencies</h2>
                  <div class="list" id="profsList"></div>
                </section>
                <section class="panel" style="margin-top:12px;">
                  <h2>Capabilities</h2>
                  <div class="list" id="skillsFeaturesList"></div>
                </section>
              </div>
              <div class="equip-col">
                <section class="panel" style="margin-top:12px;">
                  <h2>Appearance</h2>
                  <div class="portrait-frame">
                    <div class="portrait-visual" id="portraitVisual">
                      <div id="portraitSlot" class="portrait-placeholder">Portrait</div>
                    </div>
                    <div class="list" id="appearanceList"></div>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </details>

        <details class="section">
          <summary>Equipment & Treasure</summary>
          <div class="section-body">
            <div class="equipment-grid">
              <div class="equip-col">
                <section class="subsection">
                  <h3>Gear</h3>
                  <div class="list" id="equipmentGear"></div>
                </section>
                <section class="subsection">
                  <h3>Weapons</h3>
                  <div class="list" id="equipmentWeapons"></div>
                </section>
              </div>

              <div class="equip-col">
                <section class="subsection">
                  <h3>Potions</h3>
                  <div class="list" id="equipmentPotions"></div>
                </section>
                <section class="subsection">
                  <h3>Scrolls</h3>
                  <div class="list" id="equipmentScrolls"></div>
                </section>
                <section class="subsection">
                  <h3>Supplies</h3>
                  <div class="list" id="equipmentSupplies"></div>
                </section>
              </div>

              <div class="equip-col">
                <section class="subsection">
                  <h3>Treasure</h3>
                  <div id="treasureTable"></div>
                </section>
              </div>
            </div>
          </div>
        </details>

        <details class="section">
          <summary>Spells</summary>
          <div class="section-body">
            <section class="panel">
              <h2>Spellcasting</h2>
              <div class="spell-header">
                <div class="spell-field">
                  <div class="label">Spellcasting Class</div>
                  <div class="value" id="spellClass">--</div>
                </div>
                <div class="spell-field">
                  <div class="label">Spellcasting Ability</div>
                  <div class="value" id="spellAbility">--</div>
                </div>
                <div class="spell-field">
                  <div class="label">Spell Save DC</div>
                  <div class="value" id="spellSaveDc">--</div>
                </div>
                <div class="spell-field">
                  <div class="label">Spell Attack Bonus</div>
                  <div class="value" id="spellAttackBonus">--</div>
                </div>
              </div>
            </section>
            <section class="panel spell-known">
              <h2>Known & Prepared</h2>
              <div class="spells-columns" id="spellsBlock"></div>
            </section>
          </div>
        </details>

        <details class="section">
          <summary>Personality</summary>
          <div class="section-body">
            <div class="section-stack">
              <div class="personality-grid">
                <div class="personality-stack">
                  <div class="personality-bubble">
                    <div class="label">Traits</div>
                    <div class="value" id="traitTraits">--</div>
                  </div>
                  <div class="personality-bubble">
                    <div class="label">Ideals</div>
                    <div class="value" id="traitIdeals">--</div>
                  </div>
                  <div class="personality-bubble">
                    <div class="label">Bonds</div>
                    <div class="value" id="traitBonds">--</div>
                  </div>
                  <div class="personality-bubble">
                    <div class="label">Flaws</div>
                    <div class="value" id="traitFlaws">--</div>
                  </div>
                </div>

                <section class="panel">
                  <h2>Reputation</h2>
                  <div id="reputationTable"></div>
                </section>
              </div>

              <section class="panel">
                <h2>Character Backstory</h2>
                <div id="backstoryText" class="text-block empty">No backstory yet.</div>
              </section>
            </div>
          </div>
        </details>

        <details class="section">
          <summary>History</summary>
          <div class="section-body">
            <section class="panel">
              <h2>Adventure History</h2>
              <div class="list" id="historyList"></div>
            </section>
          </div>
        </details>

        <details class="section">
          <summary>Share</summary>
          <div class="section-body">
            <div class="section-grid">
              <section class="panel">
                <h2>Character Link</h2>
                <div class="list">
                  <div>
                    <a id="shareLink" href="#" target="_blank" rel="noopener">Open character page</a>
                  </div>
                </div>
              </section>
              <section class="panel">
                <h2>QR Code</h2>
                <div style="display:flex;justify-content:center;align-items:center;">
                  <img id="qrCode" alt="QR code" src="" style="width:220px;height:220px;border-radius:12px;border:1px solid rgba(0,0,0,0.12);" />
                </div>
              </section>
            </div>
          </div>
        </details>
      </section>

      <div class="sheet-footer">© 2026 Thomas Delvus. Permission is granted to copy this document for personal use.</div>
    </main>
  </div>

  <script>
    const elSheet = document.getElementById('sheet');
    const elStatus = document.getElementById('status');
    const elStatusMsg = document.getElementById('statusMsg');
    const elBackLink = document.getElementById('backLink');
    const elPlayerDashLink = document.getElementById('playerDashLink');
    const elPrintBtn = document.getElementById('printBtn');

    const SAMPLE_CHARACTER = {
      character_id: 'character_aelar',
      player_id: 'YHGxImkt3NhbT5ExZOXpIQ',
      name: 'Aelar (Sample)',
      notes_text: '',
      sheet_json: {
        identity: {
          name: 'Aelar (Sample)',
          race: 'High Elf',
          class: 'Wizard',
          subclass: 'Evocation',
          level: 10,
          background: 'Sage',
          alignment: 'Neutral Good',
          experience_points: 64000
        },
        appearance: {
          portrait_url: 'https://pub-32923a77247d4f2f9ad60bd440ec6e10.r2.dev/portraits/YHGxImkt3NhbT5ExZOXpIQ.jpg',
          age: '168',
          height: '5\'7"',
          weight: '135 lb',
          eyes: 'Emerald',
          skin: 'Fair',
          hair: 'Copper red'
        },
        abilities: { str: 8, dex: 14, con: 14, int: 18, wis: 12, cha: 10 },
        saves: { str: -1, dex: 2, con: 2, int: 6, wis: 1, cha: 0 },
        skills: { Arcana: 8, History: 6, Investigation: 6, Perception: 4, Insight: 3, Stealth: 2 },
        proficiencies: {
          armor: [],
          weapons: ['Dagger', 'Quarterstaff', 'Light Crossbow'],
          tools: ['Alchemist\'s Supplies'],
          languages: ['Common', 'Elvish', 'Draconic', 'Sylvan']
        },
        combat: {
          ac: 15,
          max_hp: 62,
          current_hp: 54,
          temp_hp: 0,
          speed_ft: 30,
          initiative_mod: 2,
          senses: []
        },
        attacks: [
          { name: 'Quarterstaff', to_hit: 6, damage: '1d6+2 bludgeoning', range: '5 ft' },
          { name: 'Fire Bolt', to_hit: 8, damage: '2d10 fire', range: '120 ft' }
        ],
        features: ['Arcane Recovery', 'Sculpt Spells', 'Empowered Evocation', 'Ritual Casting'],
        traits: ['Darkvision', 'Fey Ancestry', 'Keen Senses', 'Trance'],
        resources: { hit_dice: '10d6', spell_slots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2 } },
        spells: {
          entries: [
            { name: 'Fire Bolt', level: 0, tags: ['offense'], prepared: true },
            { name: 'Ray of Frost', level: 0, tags: ['offense'], prepared: true },
            { name: 'Mage Hand', level: 0, tags: ['utility'], prepared: true },
            { name: 'Prestidigitation', level: 0, tags: ['utility'], prepared: true },
            { name: 'Message', level: 0, tags: ['utility'], prepared: true },
            { name: 'Magic Missile', level: 1, tags: ['offense'], prepared: true },
            { name: 'Mage Armor', level: 1, tags: ['defense'], prepared: true },
            { name: 'Shield', level: 1, tags: ['defense'], prepared: true },
            { name: 'Detect Magic', level: 1, tags: ['utility'], prepared: true },
            { name: 'Misty Step', level: 2, tags: ['utility'], prepared: true },
            { name: 'Mirror Image', level: 2, tags: ['defense'], prepared: true },
            { name: 'Counterspell', level: 3, tags: ['defense'], prepared: true },
            { name: 'Fireball', level: 3, tags: ['offense'], prepared: true },
            { name: 'Dispel Magic', level: 3, tags: ['utility'], prepared: true },
            { name: 'Ice Storm', level: 4, tags: ['offense'], prepared: true },
            { name: 'Greater Invisibility', level: 4, tags: ['defense'], prepared: true },
            { name: 'Cone of Cold', level: 5, tags: ['offense'], prepared: true },
            { name: 'Wall of Force', level: 5, tags: ['defense'], prepared: true },
            { name: 'Teleportation Circle', level: 5, tags: ['utility'], prepared: true }
          ],
          slots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2 }
        },
        equipment: [
          { name: 'Robes of the Magi', category: 'Gear' },
          { name: 'Cloak of Protection', category: 'Gear' },
          { name: 'Boots of Elvenkind', category: 'Gear' },
          { name: 'Amulet of Health', category: 'Gear' },
          { name: 'Quarterstaff', category: 'Weapons' },
          { name: 'Dagger', category: 'Weapons', qty: 2 },
          { name: 'Wand of the War Mage +1', category: 'Weapons' },
          { name: 'Potion of Healing (Greater)', category: 'Potions', qty: 2 },
          { name: 'Potion of Invisibility', category: 'Potions' },
          { name: 'Scroll of Fireball', category: 'Scrolls' },
          { name: 'Scroll of Counterspell', category: 'Scrolls' },
          { name: 'Scholar\'s Pack', category: 'Supplies' },
          { name: 'Spellbook', category: 'Supplies' },
          { name: 'Ink and Quill', category: 'Supplies' },
          { name: 'Tinderbox', category: 'Supplies' },
          { name: 'Rope, 50 ft', category: 'Supplies' }
        ],
        currency: { pp: 3, gp: 1250, sp: 64, cp: 12 },
        treasure: [
          { name: 'Sapphire Key', qty: 1, value_gp: 500 },
          { name: 'Ancient signet ring', qty: 1, value_gp: 250 },
          { name: 'Spell shard', qty: 3, value_each_gp: 25 }
        ],
        personality: {
          traits: 'Always has a theory. Prefers libraries over taverns.',
          ideals: 'Knowledge should be preserved and shared.',
          bonds: 'Owes a debt to the Archivists of Evereska.',
          flaws: 'Overconfident in arcane solutions.',
          backstory: 'Raised among the Archivists of Evereska, Aelar showed a rare talent for evocation and warding. A failed experiment in the Ember Vault scattered ancient shards and nearly destroyed a wing of the library; he swore to recover the relics and repair the record. He now travels the borderlands as a discreet envoy of the Conclave, trading favors for access to lost spellcraft. Saffrondale’s saffron wealth quietly funds his research and keeps his allies supplied, though his relentless pursuit of knowledge often overrides caution.',
          reputation: [
            { faction: 'The Conclave', bonus: 2, effect: '10% discount on arcane services, scroll copying, and spell research.' },
            { faction: 'The Golden Dawn', bonus: 1, effect: 'Preferred pricing on saffron and market goods during festivals.' },
            { faction: 'The Temple Magistrates', bonus: -1, effect: 'Scrutiny at temples; donations required for expedited aid.' }
          ]
        },
        adventure_history: [
          { date: '1347-04-12', summary: 'Recovered the Sapphire Key from the Ember Vault.' },
          { date: '1347-06-01', summary: 'Closed the Rift of Thorns at Blackridge.' }
        ]
      }
    };

    const els = {
      name: document.getElementById('charName'),
      meta: document.getElementById('charMeta'),
      fieldClassLevel: document.getElementById('fieldClassLevel'),
      fieldBackground: document.getElementById('fieldBackground'),
      fieldRace: document.getElementById('fieldRace'),
      fieldAlignment: document.getElementById('fieldAlignment'),
      fieldXp: document.getElementById('fieldXp'),
      abilityList: document.getElementById('abilityList'),
      profsList: document.getElementById('profsList'),
      skillsFeaturesList: document.getElementById('skillsFeaturesList'),
      passiveValue: document.getElementById('passiveValue'),
      proficiencyValue: document.getElementById('proficiencyValue'),
      combatGrid: document.getElementById('combatGrid'),
      hpMax: document.getElementById('hpMax'),
      hpCurrent: document.getElementById('hpCurrent'),
      hpTemp: document.getElementById('hpTemp'),
      attacksBlock: document.getElementById('attacksBlock'),
      equipmentGear: document.getElementById('equipmentGear'),
      equipmentWeapons: document.getElementById('equipmentWeapons'),
      equipmentPotions: document.getElementById('equipmentPotions'),
      equipmentScrolls: document.getElementById('equipmentScrolls'),
      equipmentSupplies: document.getElementById('equipmentSupplies'),
      portraitSlot: document.getElementById('portraitSlot'),
      portraitVisual: document.getElementById('portraitVisual'),
      appearanceList: document.getElementById('appearanceList'),
      spellsBlock: document.getElementById('spellsBlock'),
      spellClass: document.getElementById('spellClass'),
      spellAbility: document.getElementById('spellAbility'),
      spellSaveDc: document.getElementById('spellSaveDc'),
      spellAttackBonus: document.getElementById('spellAttackBonus'),
      treasureTable: document.getElementById('treasureTable'),
      traitTraits: document.getElementById('traitTraits'),
      traitIdeals: document.getElementById('traitIdeals'),
      traitBonds: document.getElementById('traitBonds'),
      traitFlaws: document.getElementById('traitFlaws'),
      backstoryText: document.getElementById('backstoryText'),
      reputationTable: document.getElementById('reputationTable'),
      historyList: document.getElementById('historyList'),
      shareLink: document.getElementById('shareLink'),
      qrCode: document.getElementById('qrCode'),
    };

    function setStatus(msg, isError) {
      if (!elStatusMsg) return;
      elStatusMsg.textContent = msg;
      elStatusMsg.style.background = isError ? 'rgba(179, 60, 60, 0.5)' : 'rgba(0,0,0,0.35)';
    }

    function parseSheet(raw) {
      if (!raw) return {};
      if (typeof raw === 'object') return raw;
      if (typeof raw === 'string') {
        try { return JSON.parse(raw); } catch { return {}; }
      }
      return {};
    }

    function abilityMod(score) {
      if (!Number.isFinite(score)) return 0;
      return Math.floor((score - 10) / 2);
    }

    function formatMod(val) {
      if (!Number.isFinite(val)) return '--';
      return (val >= 0 ? '+' : '') + val;
    }

    function abilityKeyFrom(value) {
      const v = String(value || '').trim().toLowerCase();
      if (!v) return null;
      if (v.startsWith('str') || v.includes('strength')) return 'str';
      if (v.startsWith('dex') || v.includes('dexterity')) return 'dex';
      if (v.startsWith('con') || v.includes('constitution')) return 'con';
      if (v.startsWith('int') || v.includes('intelligence')) return 'int';
      if (v.startsWith('wis') || v.includes('wisdom')) return 'wis';
      if (v.startsWith('cha') || v.includes('charisma')) return 'cha';
      return null;
    }

    function abilityLabelFromKey(key) {
      const labels = { str: 'STR', dex: 'DEX', con: 'CON', int: 'INT', wis: 'WIS', cha: 'CHA' };
      return labels[key] || key || '';
    }

    function abilityKeyForClassName(name) {
      const v = String(name || '').toLowerCase();
      if (!v) return null;
      if (v.includes('wizard') || v.includes('artificer')) return 'int';
      if (v.includes('cleric') || v.includes('druid') || v.includes('ranger')) return 'wis';
      if (v.includes('bard') || v.includes('paladin') || v.includes('sorcerer') || v.includes('warlock')) return 'cha';
      return null;
    }

    function renderAbilities(abilities, saves) {
      const order = [
        ['str', 'STR'], ['dex', 'DEX'], ['con', 'CON'],
        ['int', 'INT'], ['wis', 'WIS'], ['cha', 'CHA'],
      ];
      els.abilityList.innerHTML = '';
      for (const [key, label] of order) {
        const raw = abilities && abilities[key];
        const score = Number.isFinite(Number(raw)) ? Number(raw) : null;
        const mod = score != null ? abilityMod(score) : null;
        const saveRaw = saves ? saves[key] : null;
        const saveVal = Number.isFinite(Number(saveRaw)) ? Number(saveRaw) : mod;
        const row = document.createElement('div');
        row.className = 'ability';
        row.innerHTML =
          '<div>' +
            '<div class="label">' + label + '</div>' +
            '<div class="score">' + (score != null ? score : '--') + '</div>' +
          '</div>' +
          '<div class="mod" title="Bonus">' + (mod != null ? formatMod(mod) : '--') + '</div>' +
          '<div class="save" title="Save">' + (saveVal != null ? formatMod(saveVal) : '--') + '</div>';
        els.abilityList.appendChild(row);
      }
    }

    function renderList(el, items, emptyLabel) {
      if (!el) return;
      el.innerHTML = '';
      const list = Array.isArray(items) ? items : [];
      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      for (const item of list) {
        const line = document.createElement('div');
        if (item && typeof item === 'object' && item.name != null) {
          const name = String(item.name);
          const qtyRaw = item.qty != null ? item.qty : item.quantity;
          const qty = Number.isFinite(Number(qtyRaw)) ? Number(qtyRaw) : null;
          line.textContent = qty && qty !== 1 ? (name + ' x' + qty) : name;
        } else {
          line.textContent = String(item);
        }
        el.appendChild(line);
      }
    }

    function renderKeyValueTable(el, lines, emptyLabel) {
      if (!el) return;
      const list = Array.isArray(lines) ? lines : [];
      if (!list.length) {
        el.innerHTML = '<div class="empty">' + (emptyLabel || 'None') + '</div>';
        return;
      }
      const rows = list.map((line) => {
        const text = String(line || '');
        const idx = text.indexOf(':');
        const key = idx !== -1 ? text.slice(0, idx + 1).trim() : text;
        const value = idx !== -1 ? text.slice(idx + 1).trim() : '';
        return '<tr><td>' + key + '</td><td>' + value + '</td></tr>';
      }).join('');
      el.innerHTML = '<table class="kv-table"><tbody>' + rows + '</tbody></table>';
    }

    function formatSkillLabel(name) {
      return String(name || '')
        .replace(/[_-]+/g, ' ')
        .replace(/\b\w/g, (m) => m.toUpperCase());
    }

    function formatSkillValue(val) {
      if (!Number.isFinite(Number(val))) return String(val ?? '');
      const num = Number(val);
      return (num >= 0 ? '+' : '') + num;
    }

    function renderKeyValueList(el, obj, labels, emptyLabel) {
      if (!el) return;
      el.innerHTML = '';
      if (!obj || typeof obj !== 'object') {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      const entries = Object.entries(obj);
      if (!entries.length) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = emptyLabel || 'None';
        el.appendChild(empty);
        return;
      }
      entries.forEach(([key, val]) => {
        const line = document.createElement('div');
        const name = labels && labels[key] ? labels[key] : key;
        line.textContent = name + ': ' + String(val);
        el.appendChild(line);
      });
    }

    function renderCombatMini(combat) {
      const boxes = [
        { label: 'Armor Class', value: combat.ac != null ? combat.ac : '--' },
        { label: 'Initiative', value: combat.initiative_mod != null ? formatMod(Number(combat.initiative_mod)) : '--' },
        { label: 'Speed', value: combat.speed_ft != null ? combat.speed_ft + ' ft' : '--' }
      ];
      els.combatGrid.innerHTML = boxes.map(b =>
        '<div class="mini-box"><div class="label">' + b.label + '</div><div class="value">' + b.value + '</div></div>'
      ).join('');
    }

    function renderPassives(passive, proficiency) {
      els.passiveValue.textContent = passive;
      if (proficiency == null) {
        els.proficiencyValue.textContent = '--';
      } else {
        els.proficiencyValue.textContent = formatMod(Number(proficiency));
      }
    }

    function proficiencyBonus(level) {
      const lvl = Number(level);
      if (!Number.isFinite(lvl) || lvl <= 0) return null;
      return 2 + Math.floor((lvl - 1) / 4);
    }

    function renderSpellHeader(identity, abilities, spells, spellcasting, profValue) {
      const spellsObj = (spells && typeof spells === 'object') ? spells : {};
      const spellcastingObj = (spellcasting && typeof spellcasting === 'object') ? spellcasting : {};
      const meta = { ...spellsObj, ...spellcastingObj };

      const classRaw =
        meta.class ||
        meta.casting_class ||
        meta.spellcasting_class ||
        (identity && identity.class) ||
        '--';
      els.spellClass.textContent = classRaw || '--';

      const abilityRaw =
        meta.ability ||
        meta.spellcasting_ability ||
        meta.casting_ability ||
        meta.ability_key;
      let abilityKey = abilityKeyFrom(abilityRaw);
      if (!abilityKey) abilityKey = abilityKeyForClassName(identity && identity.class);
      const abilityLabel = abilityKey
        ? abilityLabelFromKey(abilityKey)
        : (abilityRaw ? String(abilityRaw).toUpperCase() : '--');
      els.spellAbility.textContent = abilityLabel || '--';

      const explicitDc = toNumber(
        meta.save_dc ?? meta.saveDc ?? meta.spell_save_dc ?? meta.spellSaveDc
      );
      const explicitAttack = toNumber(
        meta.attack_bonus ?? meta.attackBonus ?? meta.spell_attack_bonus ?? meta.spellAttackBonus
      );

      const mod = abilityKey && abilities
        ? abilityMod(Number(abilities[abilityKey]))
        : null;
      const prof = Number.isFinite(Number(profValue)) ? Number(profValue) : null;
      const dc = Number.isFinite(explicitDc)
        ? explicitDc
        : (mod != null && prof != null ? 8 + mod + prof : null);
      const atk = Number.isFinite(explicitAttack)
        ? explicitAttack
        : (mod != null && prof != null ? mod + prof : null);

      els.spellSaveDc.textContent = dc != null ? dc : '--';
      els.spellAttackBonus.textContent = atk != null ? formatMod(atk) : '--';
    }

    function setTextBlock(el, text, emptyLabel) {
      if (!el) return;
      const value = text != null ? String(text).trim() : '';
      if (value) {
        el.textContent = value;
        el.classList.remove('empty');
      } else {
        el.textContent = emptyLabel || 'None';
        el.classList.add('empty');
      }
    }

    function normalizeReputationRows(value) {
      if (!value) return [];
      const list = Array.isArray(value) ? value : [value];
      return list.map((entry) => {
        if (entry == null) return null;
        if (typeof entry === 'string') {
          return { faction: entry.trim(), bonus: '', effect: '' };
        }
        if (typeof entry !== 'object') {
          return { faction: String(entry).trim(), bonus: '', effect: '' };
        }
        const faction = entry.faction ?? entry.name ?? entry.group ?? entry.title ?? '';
        const bonusRaw = entry.bonus ?? entry.score ?? entry.rep ?? entry.value ?? entry.points ?? null;
        const bonusNum = Number.isFinite(Number(bonusRaw)) ? Number(bonusRaw) : null;
        const bonus = bonusNum != null ? (bonusNum >= 0 ? '+' : '') + bonusNum : (bonusRaw != null ? String(bonusRaw) : '');
        const effect = entry.effect ?? entry.perk ?? entry.benefit ?? entry.note ?? '';
        return { faction: String(faction).trim(), bonus: String(bonus).trim(), effect: String(effect).trim() };
      }).filter(row => row && (row.faction || row.bonus || row.effect));
    }

    function renderReputationTable(value) {
      if (!els.reputationTable) return;
      const rows = normalizeReputationRows(value);
      if (!rows.length) {
        els.reputationTable.innerHTML = '<div class="empty">No reputation notes.</div>';
        return;
      }
      const body = rows.map((row) => {
        const faction = row.faction || '--';
        const bonus = row.bonus || '--';
        const effect = row.effect || '--';
        return '<tr><td>' + faction + '</td><td>' + bonus + '</td><td>' + effect + '</td></tr>';
      }).join('');
      els.reputationTable.innerHTML =
        '<table class="reputation-table">' +
          '<thead><tr><th>Faction</th><th>Bonus</th><th>Effect</th></tr></thead>' +
          '<tbody>' + body + '</tbody>' +
        '</table>';
    }

    function renderHp(combat) {
      const maxHp = combat.max_hp != null ? combat.max_hp : '--';
      const currentHp = combat.current_hp != null ? combat.current_hp : (combat.hp != null ? combat.hp : '--');
      const tempHp = combat.temp_hp != null ? combat.temp_hp : (combat.temp != null ? combat.temp : '--');
      els.hpMax.textContent = maxHp;
      els.hpCurrent.textContent = currentHp;
      els.hpTemp.textContent = tempHp;
    }

    function renderAttacks(attacks) {
      if (!Array.isArray(attacks) || !attacks.length) {
        els.attacksBlock.innerHTML = '<div class="empty">No attacks listed.</div>';
        return;
      }
      const rows = attacks.map((a) => {
        const name = a && a.name ? a.name : 'Attack';
        const toHit = a && (a.to_hit != null ? a.to_hit : a.toHit != null ? a.toHit : '');
        const damage = a && (a.damage != null ? a.damage : a.dmg != null ? a.dmg : '');
        const range = a && (a.range != null ? a.range : a.rng != null ? a.rng : '');
        return '<tr><td>' + name + '</td><td>' + toHit + '</td><td>' + damage + '</td><td>' + range + '</td></tr>';
      }).join('');
      els.attacksBlock.innerHTML =
        '<table><thead><tr><th>Name</th><th>To Hit</th><th>Damage/Type</th><th>Range</th></tr></thead><tbody>' +
          rows +
          '</tbody></table>';
    }

    function normalizeSpellEntries(spells) {
      if (!spells || typeof spells !== 'object') return [];
      const entries = Array.isArray(spells.entries) ? spells.entries : [];
      if (entries.length) return entries;

      const known = Array.isArray(spells.known) ? spells.known : [];
      const prepared = new Set(Array.isArray(spells.prepared) ? spells.prepared : []);
      return known.map((name) => ({
        name,
        level: null,
        tags: [],
        prepared: prepared.has(name)
      }));
    }

    function spellGroupFor(tags) {
      const list = Array.isArray(tags) ? tags : [tags];
      const norm = list.map(t => String(t || '').toLowerCase());
      if (norm.includes('offense') || norm.includes('offensive') || norm.includes('damage')) return 'offense';
      if (norm.includes('defense') || norm.includes('defensive') || norm.includes('protection')) return 'defense';
      if (norm.includes('utility') || norm.includes('support') || norm.includes('control')) return 'utility';
      return 'utility';
    }

    function renderSpells(spells) {
      const entries = normalizeSpellEntries(spells);
      if (!entries.length) {
        els.spellsBlock.innerHTML = '<div class="empty">No spells listed.</div>';
        return;
      }

      const groups = { offense: [], defense: [], utility: [] };
      for (const raw of entries) {
        if (!raw) continue;
        const name = raw.name != null ? String(raw.name) : '';
        if (!name) continue;
        const level = Number.isFinite(Number(raw.level)) ? Number(raw.level) : null;
        const prepared = !!raw.prepared;
        const tags = raw.tags || raw.tag || raw.type || [];
        const group = spellGroupFor(tags);
        groups[group].push({ name, level, prepared });
      }

      const sortSpells = (a, b) => {
        const la = (a.level == null) ? -1 : a.level;
        const lb = (b.level == null) ? -1 : b.level;
        if (lb !== la) return lb - la;
        return a.name.localeCompare(b.name);
      };

      const renderGroup = (title, list) => {
        const sorted = list.slice().sort(sortSpells);
        const items = sorted.map((s) => {
          const levelText = (s.level == null) ? '' : ('L' + s.level);
          const prepared = s.prepared ? '✅' : '';
          return '<div class="spell-item"><span class="spell-level">' + levelText + '</span><span>' + s.name + '</span><span style="margin-left:auto;">' + prepared + '</span></div>';
        }).join('');
        const body = items || '<div class="empty">None</div>';
        return '<div class="spell-group"><h3>' + title + '</h3><div class="spell-list">' + body + '</div></div>';
      };

      els.spellsBlock.innerHTML =
        renderGroup('Offense', groups.offense) +
        renderGroup('Defense', groups.defense) +
        renderGroup('Utility', groups.utility);
    }

    function renderPortrait(appearance) {
      const url = appearance && appearance.portrait_url ? String(appearance.portrait_url) : '';
      if (!url) return;
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Portrait';
      if (els.portraitSlot && els.portraitSlot.parentElement) {
        els.portraitSlot.parentElement.replaceChild(img, els.portraitSlot);
        els.portraitSlot = img;
      }
    }

    function normalizeCategory(cat) {
      const name = String(cat || '').toLowerCase();
      if (!name) return null;
      if (name.includes('weapon')) return 'weapons';
      if (name.includes('potion') || name.includes('elixir')) return 'potions';
      if (name.includes('scroll')) return 'scrolls';
      if (name.includes('supply') || name.includes('kit')) return 'supplies';
      if (name.includes('gear') || name.includes('equipped') || name.includes('armor') || name.includes('worn')) return 'gear';
      return null;
    }

    function inferCategoryFromName(name) {
      const lowered = String(name || '').toLowerCase();
      if (!lowered) return 'gear';
      if (['sword', 'dagger', 'axe', 'bow', 'crossbow', 'staff', 'mace', 'spear', 'hammer', 'wand'].some(w => lowered.includes(w))) {
        return 'weapons';
      }
      if (['potion', 'elixir', 'vial'].some(w => lowered.includes(w))) return 'potions';
      if (['scroll'].some(w => lowered.includes(w))) return 'scrolls';
      if (['rations', 'rope', 'torch', 'tinder', 'kit', 'pack', 'bedroll', 'tools', 'supplies'].some(w => lowered.includes(w))) {
        return 'supplies';
      }
      return 'gear';
    }

    function toNumber(value) {
      if (typeof value === 'number' && Number.isFinite(value)) return value;
      if (typeof value === 'string') {
        const trimmed = value.replace(/,/g, '').trim();
        if (!trimmed) return null;
        const parsed = Number(trimmed);
        return Number.isFinite(parsed) ? parsed : null;
      }
      return null;
    }

    function formatGp(value) {
      if (!Number.isFinite(value)) return '--';
      const rounded = Math.round(value * 100) / 100;
      return rounded.toFixed(2);
    }

    function renderTreasureTable(treasure, currency) {
      const rows = [];
      let total = 0;

      const addRow = (name, qty, valueGp) => {
        const qtyVal = Number.isFinite(Number(qty)) ? Number(qty) : '';
        const valueText = Number.isFinite(valueGp) ? formatGp(valueGp) : '--';
        rows.push({ name, qty: qtyVal, value: valueText });
        if (Number.isFinite(valueGp)) total += valueGp;
      };

      const rates = { pp: 10, gp: 1, sp: 0.1, cp: 0.01, ep: 0.5 };
      if (currency && typeof currency === 'object') {
        Object.entries(currency).forEach(([key, raw]) => {
          const qty = toNumber(raw);
          if (!Number.isFinite(qty) || qty === 0) return;
          const unit = rates[key.toLowerCase()];
          const valueGp = Number.isFinite(unit) ? qty * unit : null;
          addRow(key.toUpperCase(), qty, valueGp);
        });
      }

      const list = Array.isArray(treasure) ? treasure : [];
      for (const item of list) {
        if (!item) continue;
        if (typeof item === 'string') {
          addRow(item, 1, null);
          continue;
        }
        const name = item.name != null ? String(item.name) : 'Item';
        const qty = toNumber(item.qty != null ? item.qty : item.quantity) || 1;
        const each = toNumber(item.value_each_gp != null ? item.value_each_gp : item.value_each);
        let valueGp = null;
        if (Number.isFinite(each)) {
          valueGp = each * qty;
        } else {
          valueGp = toNumber(item.value_gp != null ? item.value_gp : (item.gp_value != null ? item.gp_value : item.value));
        }
        addRow(name, qty, valueGp);
      }

      if (!rows.length) {
        els.treasureTable.innerHTML = '<div class="empty">No treasure listed.</div>';
        return;
      }

      const body = rows.map((row) =>
        '<tr><td>' + row.name + '</td><td>' + row.qty + '</td><td>' + row.value + '</td></tr>'
      ).join('');
      const totalRow = '<tr><td style="font-weight:600;">Total</td><td></td><td style="font-weight:600;">' + formatGp(total) + '</td></tr>';
      els.treasureTable.innerHTML =
        '<table class="treasure-table">' +
          '<thead><tr><th>Item</th><th>Qty</th><th>Gold Value</th></tr></thead>' +
          '<tbody>' + body + totalRow + '</tbody>' +
        '</table>';
    }

    function renderSheet(character) {
      const sheet = parseSheet(character.sheet_json);
      const identity = sheet.identity || {};
      const appearance = sheet.appearance || {};
      const personality = sheet.personality || {};

      const name = identity.name || character.name || 'Unknown';
      const klass = identity.class || identity.class_name || '';
      const level = identity.level != null ? identity.level : '';
      const race = identity.race || '';
      const background = identity.background || '';
      const alignment = identity.alignment || '';
      const xp = identity.experience_points || identity.xp || '';

      document.title = name + ' - Character Sheet';
      els.name.textContent = name;
      els.meta.textContent = '';
      els.meta.style.display = 'none';

      const classLevel = klass && level ? (klass + ' ' + level) : (klass || level || '--');
      els.fieldClassLevel.textContent = classLevel || '--';
      els.fieldBackground.textContent = background || '--';
      els.fieldRace.textContent = race || '--';
      els.fieldAlignment.textContent = alignment || '--';
      els.fieldXp.textContent = xp || '--';

      renderAbilities(sheet.abilities || {}, sheet.saves || {});

      const combat = sheet.combat || {};
      const passivePerception = (sheet.skills && Number.isFinite(Number(sheet.skills.perception)))
        ? 10 + Number(sheet.skills.perception)
        : '--';
      renderCombatMini(combat);
      const profExplicit =
        sheet.proficiency_bonus ??
        sheet.proficiencyBonus ??
        combat.proficiency_bonus ??
        combat.proficiencyBonus ??
        identity.proficiency_bonus ??
        identity.proficiencyBonus;
      const profValue = profExplicit != null ? Number(profExplicit) : proficiencyBonus(identity.level);
      renderPassives(passivePerception, profValue);
      renderSpellHeader(identity, sheet.abilities || {}, sheet.spells || {}, sheet.spellcasting || {}, profValue);
      renderHp(combat);

      if (appearance && !appearance.portrait_url) {
        appearance.portrait_url =
          'https://pub-32923a77247d4f2f9ad60bd440ec6e10.r2.dev/portraits/' +
          encodeURIComponent(character.character_id || 'character_aelar') +
          '.jpg';
      }
      renderPortrait(appearance);

      const appearanceFields = [
        ['Age', appearance.age],
        ['Height', appearance.height],
        ['Weight', appearance.weight],
        ['Eyes', appearance.eyes],
        ['Skin', appearance.skin],
        ['Hair', appearance.hair]
      ].filter(([, v]) => v != null && v !== '');
      if (appearanceFields.length) {
        els.appearanceList.innerHTML = appearanceFields
          .map(([k, v]) => '<div>' + k + ': ' + v + '</div>')
          .join('');
        els.appearanceList.style.display = 'grid';
      } else {
        els.appearanceList.innerHTML = '';
        els.appearanceList.style.display = 'none';
      }

      const profs = sheet.proficiencies || {};
      const profLines = [];
      if (Array.isArray(profs.armor) && profs.armor.length) profLines.push('Armor: ' + profs.armor.join(', '));
      if (Array.isArray(profs.weapons) && profs.weapons.length) profLines.push('Weapons: ' + profs.weapons.join(', '));
      if (Array.isArray(profs.tools) && profs.tools.length) profLines.push('Tools: ' + profs.tools.join(', '));
      if (Array.isArray(profs.languages) && profs.languages.length) profLines.push('Languages: ' + profs.languages.join(', '));
      renderKeyValueTable(els.profsList, profLines, 'No proficiencies listed.');

      renderAttacks(sheet.attacks);
      const skillsEntries = [];
      if (sheet.skills && typeof sheet.skills === 'object') {
        for (const [key, value] of Object.entries(sheet.skills)) {
          skillsEntries.push(formatSkillLabel(key) + ' ' + formatSkillValue(value));
        }
      }
      const skillsLine = skillsEntries.length ? ('Skills: ' + skillsEntries.join(', ')) : '';
      const featuresLine = Array.isArray(sheet.features) && sheet.features.length
        ? ('Features: ' + sheet.features.join(', '))
        : '';
      const traitsRaw = sheet.traits ?? sheet.racial_traits ?? sheet.racialTraits;
      const traitsList = Array.isArray(traitsRaw)
        ? traitsRaw
        : (typeof traitsRaw === 'string' && traitsRaw.trim() ? [traitsRaw.trim()] : []);
      const traitsLine = traitsList.length ? ('Traits: ' + traitsList.join(', ')) : '';
      const combinedLines = [skillsLine, featuresLine, traitsLine].filter(Boolean);
      renderKeyValueTable(els.skillsFeaturesList, combinedLines, 'No skills or features listed.');
      const equipment = Array.isArray(sheet.equipment) ? sheet.equipment : (Array.isArray(sheet.inventory) ? sheet.inventory : []);
      const buckets = { gear: [], weapons: [], potions: [], scrolls: [], supplies: [] };

      for (const raw of equipment) {
        const name = (raw && typeof raw === 'object' && raw.name != null) ? raw.name : raw;
        const nameText = String(name || '');
        if (!nameText) continue;
        const cat = raw && typeof raw === 'object' ? normalizeCategory(raw.category) : null;
        const bucket = cat || inferCategoryFromName(nameText);
        (buckets[bucket] || buckets.gear).push(raw);
      }

      renderList(els.equipmentGear, buckets.gear, 'None');
      renderList(els.equipmentWeapons, buckets.weapons, 'None');
      renderList(els.equipmentPotions, buckets.potions, 'None');
      renderList(els.equipmentScrolls, buckets.scrolls, 'None');
      renderList(els.equipmentSupplies, buckets.supplies, 'None');

      renderSpells(sheet.spells);
      renderTreasureTable(sheet.treasure, sheet.currency);

      if (els.traitTraits) els.traitTraits.textContent = personality.traits ? String(personality.traits) : '--';
      if (els.traitIdeals) els.traitIdeals.textContent = personality.ideals ? String(personality.ideals) : '--';
      if (els.traitBonds) els.traitBonds.textContent = personality.bonds ? String(personality.bonds) : '--';
      if (els.traitFlaws) els.traitFlaws.textContent = personality.flaws ? String(personality.flaws) : '--';

      const backstory =
        personality.backstory ??
        sheet.backstory ??
        identity.backstory ??
        '';
      const reputation =
        personality.reputation ??
        personality.allies ??
        personality.organizations ??
        character.notes_text ??
        '';
      setTextBlock(els.backstoryText, backstory, 'No backstory yet.');
      renderReputationTable(reputation);

      const history = Array.isArray(sheet.adventure_history) ? sheet.adventure_history : [];
      const historyLines = history.map(h => {
        if (h && typeof h === 'object') {
          const date = h.date ? String(h.date) + ': ' : '';
          return date + (h.summary ? String(h.summary) : JSON.stringify(h));
        }
        return String(h);
      });
      renderList(els.historyList, historyLines, 'No history yet.');

      if (elPlayerDashLink) {
        const pid = character.player_id || sheet.player_id || sheet.playerId;
        elPlayerDashLink.href = pid
          ? ('/app/player.html?player_id=' + encodeURIComponent(pid))
          : '/app/player.html';
      }

      const shareId = character.character_id || 'character_aelar';
      const shareUrl =
        'https://delvus.net/app/character/' +
        encodeURIComponent(shareId);
      if (els.shareLink) {
        els.shareLink.textContent = shareUrl;
        els.shareLink.href = shareUrl;
      }
      if (els.qrCode) {
        els.qrCode.src =
          'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' +
          encodeURIComponent(shareUrl);
      }

      // Base Stats uses the main layout; no cloning needed.

      // Notes text is now surfaced in Reputation (fallback), so no separate notes block.
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      let characterId = params.get('character_id') || params.get('characterId') || params.get('id');
      if (!characterId) {
        const pathMatch = location.pathname.match(/\/app\/character\/([^\/?#]+)/i);
        if (pathMatch && pathMatch[1]) characterId = decodeURIComponent(pathMatch[1]);
      }
      let useSample = false;
      const battleId = params.get('battle_id') || params.get('battleId') || params.get('battle');
      if (battleId && elBackLink) {
        elBackLink.href = '/app/battlemat.html?battle_id=' + encodeURIComponent(battleId);
      }
      let detailsState = null;
      if (elPrintBtn) {
        elPrintBtn.addEventListener('click', () => {
          const sections = Array.from(document.querySelectorAll('details.section'));
          detailsState = sections.map(section => section.open);
          sections.forEach(section => { section.open = true; });
          window.print();
        });
      }
      window.addEventListener('afterprint', () => {
        if (!detailsState) return;
        const sections = Array.from(document.querySelectorAll('details.section'));
        sections.forEach((section, idx) => {
          section.open = !!detailsState[idx];
        });
        detailsState = null;
      });
      if (!characterId) {
        characterId = 'character_aelar';
        setStatus('No character_id in URL. Loading sample character.', false);
        useSample = true;
      }

      try {
        const res = await fetch('/api/characters/' + encodeURIComponent(characterId), {
          method: 'GET',
          cache: 'no-store',
          headers: { 'Accept': 'application/json' },
        });
        if (!res.ok) {
          if (useSample) {
            renderSheet(SAMPLE_CHARACTER);
            if (elStatus) elStatus.hidden = true;
            if (elSheet) elSheet.hidden = false;
            return;
          }
          setStatus('Failed to load character (' + res.status + ').', true);
          return;
        }
        const data = await res.json();
        renderSheet(data || {});
        if (elStatus) elStatus.hidden = true;
        if (elSheet) elSheet.hidden = false;
      } catch (e) {
        setStatus('Failed to load character.', true);
      }
    }

    init();
  </script>
</body>
</html>
