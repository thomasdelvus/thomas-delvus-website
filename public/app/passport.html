<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player Passport</title>
  <style>
    :root{
      --ink:#2b2416;
      --muted:#6a5c45;
      --accent:#3b2a12;
      --bg:#16181f;
      --paper:#f1e4c7;
      --panel:#fff8e7;

      /* Tweak these to position text on the background image */
      --name-x: 54%;
      --name-y: 67%;
      --version-x: 75%;
      --version-y: 67%;
      --id-x: 54%;
      --id-y: 77%;
      --date-x: 75%;
      --date-y: 77%;
      --qr-x: 28.5%;
      --qr-y: 72.5%;
      --qr-size: 90px;
      --token-x: 32%;
      --token-y: 81%;
      --token-max-width: 235px;
      --portrait-x: 68.75%;
      --portrait-y: 46.1%;
      --portrait-size: 170px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Garamond","Book Antiqua",serif;
      background:var(--bg);
      color:var(--ink);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:16px 20px;
      color:#e8edf7;
    }
    .brand{
      font-family:"Copperplate Gothic","Garamond","Book Antiqua",serif;
      letter-spacing:0.12em;
      text-transform:uppercase;
      font-size:14px;
    }
    .nav{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .nav a,
    .nav button{
      color:#e8edf7;
      background:transparent;
      border:1px solid rgba(255,255,255,0.22);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      cursor:pointer;
      text-decoration:none;
      font-family:inherit;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto 40px;
      padding:0 18px 24px;
    }
    .sheet{
      position:relative;
      border-radius:16px;
      background:var(--paper);
      overflow:hidden;
      box-shadow:0 18px 40px rgba(0,0,0,0.35);
    }
    .print-summary{
      display:none;
      margin:0;
      padding:18px 20px 24px;
      background:transparent;
      border-radius:0;
      border:none;
      color:var(--ink);
    }
    .print-summary h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:#4a3b27;
    }
    .summary-grid{
      display:grid;
      grid-template-columns:1.05fr 0.95fr;
      gap:16px;
      font-size:12px;
    }
    .summary-table{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }
    .summary-row{
      display:grid;
      grid-template-columns:1.4fr 0.6fr 1.2fr 0.9fr 1.4fr;
      gap:8px;
      align-items:baseline;
    }
    .summary-row.header{
      font-size:11px;
      letter-spacing:0.1em;
      text-transform:uppercase;
      color:#4a3b27;
      font-weight:700;
    }
    .summary-cell{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .summary-block h3{
      margin:0 0 6px 0;
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:#4a3b27;
    }
    .summary-list{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .summary-item{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .summary-item .label{
      font-weight:700;
    }
    .summary-item .meta{
      color:#4a3b27;
    }
    .passport-img{
      width:100%;
      display:block;
    }
    .overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .field{
      position:absolute;
      transform:translateY(-50%);
      color:var(--accent);
      font-weight:700;
      text-shadow:0 1px 0 rgba(255,255,255,0.6);
      text-align:left;
    }
    .field .label{
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:4px;
    }
    .field .value{
      font-size:18px;
      font-weight:700;
    }
    .field.small .value{
      font-size:12px;
      font-weight:600;
      letter-spacing:0.02em;
    }
    .token-row{
      position:absolute;
      transform:translate(-50%, -50%);
      display:flex;
      align-items:center;
      gap:10px;
      width:var(--token-max-width);
      color:var(--accent);
      font-size:12px;
      font-weight:600;
    }
    .token-value{
      font-family:"Courier New",monospace;
      white-space:nowrap;
      flex:1;
    }
    .copy-btn{
      pointer-events:auto;
      background:transparent;
      border:1px solid rgba(47,35,20,0.35);
      border-radius:999px;
      padding:2px 6px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--ink);
      cursor:pointer;
    }
    .copy-btn.hidden{
      display:none;
    }
    .field.compact .value{
      font-size:15px;
      letter-spacing:0.01em;
    }
    .qr{
      position:absolute;
      transform:translate(-50%, -50%);
      width:var(--qr-size);
      height:var(--qr-size);
      padding:0;
      background:transparent;
      border-radius:0;
      box-shadow:none;
      pointer-events:auto;
    }
    .qr img{
      display:block;
      width:100%;
      height:100%;
      object-fit:contain;
      image-rendering:pixelated;
    }
    .portrait{
      position:absolute;
      transform:translate(-50%, -50%);
      width:var(--portrait-size);
      height:var(--portrait-size);
      border-radius:50%;
      overflow:hidden;
      box-shadow:0 6px 14px rgba(0,0,0,0.2);
    }
    .portrait img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
    }
    .status{
      text-align:center;
      color:#e8edf7;
      padding:18px 10px;
      font-size:14px;
    }
    .status .msg{
      display:inline-block;
      padding:10px 14px;
      border-radius:12px;
      background:rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.18);
    }
    @media print{
      @page{
        size: letter;
        margin: 0.4in;
      }
      html,body{
        height:100%;
        background:#f1e4c7 url("/assets/sprites/parchment.png") center/cover no-repeat;
      }
      .topbar,.status{display:none !important;}
      .wrap{
        max-width:none;
        margin:0;
        padding:0;
        min-height:100%;
        background:#f1e4c7 url("/assets/sprites/parchment.png") center/cover no-repeat;
      }
      .sheet{box-shadow:none;border:none;border-radius:0;}
      .print-summary{
        display:block;
        padding-left:0.35in;
        padding-right:0.4in;
      }
      :root{
        --qr-size: 70px;
        --token-max-width: 240px;
        --token-x: 33%;
        --portrait-size: 136px;
      }
      .field.compact .value{
        font-size:13px;
      }
      #nameField .value,
      #versionField .value,
      #dateField .value{
        font-size:13px;
      }
      .copy-btn{
        display:none;
      }
    }
  </style>
<body>
  <div class="topbar">
    <div class="brand">Player Passport</div>
    <div class="nav">
      <button type="button" id="printBtn">Print</button>
      <button type="button" id="downloadBtn">Download Passport</button>
      <a href="/app/player.html" id="backLink">Back to Dashboard</a>
    </div>
  </div>

  <div class="status" id="status"><div class="msg" id="statusMsg">Loading passport...</div></div>

  <div class="wrap" id="wrap" hidden>
    <div class="sheet">
      <img
        class="passport-img"
        id="passportBg"
        src="https://pub-e0f018cf20e24c12a47609c28946b7a1.r2.dev/passports/player_passport.jpg"
        alt="Player Passport Background"
      />
      <div class="overlay">
        <div class="portrait" id="passportPortrait" style="left:var(--portrait-x); top:var(--portrait-y);" hidden>
          <img id="passportPortraitImg" alt="Passport portrait" />
        </div>
        <a class="qr" id="passportQr" style="left:var(--qr-x); top:var(--qr-y);" target="_blank" rel="noopener">
          <img id="passportQrImg" alt="Passport QR code" />
        </a>
        <div class="token-row" id="tokenRow" style="left:var(--token-x); top:var(--token-y);">
          <span class="token-value" id="passportToken">--</span>
          <button class="copy-btn" type="button" id="copyTokenBtn">Copy Key</button>
        </div>
        <div class="field" id="nameField" style="left:var(--name-x); top:var(--name-y);">
          <div class="label">Player Name</div>
          <div class="value" id="playerName">Unknown</div>
        </div>
        <div class="field" id="versionField" style="left:var(--version-x); top:var(--version-y);">
          <div class="label">Version</div>
          <div class="value" id="passportVersion">v1.0</div>
        </div>
        <div class="field compact" id="idField" style="left:var(--id-x); top:var(--id-y);">
          <div class="label">Passport Number</div>
          <div class="value" id="playerId">--</div>
        </div>
        <div class="field" id="dateField" style="left:var(--date-x); top:var(--date-y);">
          <div class="label">Date</div>
          <div class="value" id="passportDate">--</div>
        </div>
      </div>
    </div>
    <div class="print-summary" id="printSummary">
      <h2 id="summaryTitle">Player Summary</h2>
      <div class="summary-grid">
        <div class="summary-block">
          <h3>Characters</h3>
          <div class="summary-table" id="summaryCharacters"></div>
        </div>
        <div class="summary-block">
          <h3>Campaigns</h3>
          <div class="summary-list" id="summaryCampaigns"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const elStatus = document.getElementById('status');
    const elStatusMsg = document.getElementById('statusMsg');
    const elWrap = document.getElementById('wrap');
    const elPlayerName = document.getElementById('playerName');
    const elPlayerId = document.getElementById('playerId');
    const elBackLink = document.getElementById('backLink');
    const elPrint = document.getElementById('printBtn');
    const elDownload = document.getElementById('downloadBtn');
    const elPassportVersion = document.getElementById('passportVersion');
    const elPassportDate = document.getElementById('passportDate');
    const elPassportToken = document.getElementById('passportToken');
    const elPassportQrImg = document.getElementById('passportQrImg');
    const elPassportQr = document.getElementById('passportQr');
    const elCopyTokenBtn = document.getElementById('copyTokenBtn');
    const elPassportPortrait = document.getElementById('passportPortrait');
    const elPassportPortraitImg = document.getElementById('passportPortraitImg');
    const PORTRAIT_BASE = 'https://pub-32923a77247d4f2f9ad60bd440ec6e10.r2.dev/portraits/';
    const DASHBOARD_BASE = 'https://delvus.net/app/player.html';
    const elSummaryCharacters = document.getElementById('summaryCharacters');
    const elSummaryCampaigns = document.getElementById('summaryCampaigns');
    const IS_SNAPSHOT = document.documentElement.hasAttribute('data-passport-snapshot');

    const SAMPLE_PLAYER = {
      player_id: 'sample_player_id',
      display_name: 'Robert Costa',
      dashboard_token: 'sample_dashboard_token',
      passport_character_id: ''
    };

    function setStatus(msg) {
      elStatusMsg.textContent = msg;
    }

    function render(player) {
      elWrap.hidden = false;
      elStatus.style.display = 'none';
      elPlayerName.textContent = player.display_name || 'Unnamed Player';
      elPlayerId.textContent = player.player_id || '--';
      const token = player.dashboard_token || '';
      if (elPassportToken) elPassportToken.textContent = token || '--';
      if (elPassportQrImg) {
        const playerId = player.player_id || '';
        const dashboardUrl =
          DASHBOARD_BASE +
          (playerId ? ('?player_id=' + encodeURIComponent(playerId)) : '') +
          (token ? ('#passport=' + encodeURIComponent(token)) : '');
        if (elPassportQr) elPassportQr.href = dashboardUrl;
        if (token || playerId) {
          elPassportQrImg.src =
            'https://api.qrserver.com/v1/create-qr-code/?size=220x220&margin=0&bgcolor=dfac75&color=2b2416&data=' +
            encodeURIComponent(dashboardUrl);
        }
      }
      if (elPassportVersion) {
        const version = (player.version != null) ? String(player.version) : '1.0';
        elPassportVersion.textContent = 'v' + version;
      }
      if (elPassportDate) {
        const d = new Date();
        const stamp = d.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: '2-digit' });
        elPassportDate.textContent = stamp;
        const elSummaryTitle = document.getElementById('summaryTitle');
        if (elSummaryTitle) elSummaryTitle.textContent = `Player Summary (as of ${stamp})`;
      }
      if (elBackLink) {
        elBackLink.href = player.player_id
          ? ('/app/player.html?player_id=' + encodeURIComponent(player.player_id))
          : '/app/player.html';
      }
    }

    function renderSummaryList(el, items, type) {
      if (!el) return;
      el.innerHTML = '';
      if (!items || !items.length) {
        const empty = document.createElement('div');
        empty.className = 'summary-item';
        empty.textContent = 'None';
        el.appendChild(empty);
        return;
      }
      items.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'summary-item';
        const label = document.createElement('div');
        label.className = 'label';
        if (type === 'character' && item.detail) {
          label.textContent = (item.name || 'Unnamed') + ' (' + item.detail + ')';
        } else {
          label.textContent = item.name || 'Unnamed';
        }
        row.appendChild(label);
        const meta = document.createElement('div');
        meta.className = 'meta';
        if (type === 'character') {
          meta.textContent = item.campaign_name ? ('Campaign: ' + item.campaign_name) : (item.campaign_id ? 'Campaign: ' + item.campaign_id : 'Unbound');
        } else {
          const status = item.status || 'Active';
          meta.textContent = status + (item.summary_text ? (' - ' + item.summary_text) : '');
        }
        row.appendChild(meta);
        el.appendChild(row);
      });
    }

    function renderCharacterTable(el, items) {
      if (!el) return;
      el.innerHTML = '';
      const header = document.createElement('div');
      header.className = 'summary-row header';
      header.innerHTML = `
        <div class="summary-cell">Character</div>
        <div class="summary-cell">Lvl</div>
        <div class="summary-cell">Race</div>
        <div class="summary-cell">Class</div>
        <div class="summary-cell">Campaign</div>
      `;
      el.appendChild(header);
      if (!items || !items.length) {
        const empty = document.createElement('div');
        empty.className = 'summary-row';
        empty.innerHTML = `<div class="summary-cell">None</div>`;
        el.appendChild(empty);
        return;
      }
      items.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'summary-row';
        row.innerHTML = `
          <div class="summary-cell">${item.name || 'Unnamed'}</div>
          <div class="summary-cell">${item.level || '--'}</div>
          <div class="summary-cell">${item.race || '--'}</div>
          <div class="summary-cell">${item.class_name || '--'}</div>
          <div class="summary-cell">${item.campaign_name || item.campaign_id || 'Unbound'}</div>
        `;
        el.appendChild(row);
      });
    }
    async function enrichCharacters(chars) {
      const enriched = await Promise.all((chars || []).map(async (c) => {
        if (!c || !c.character_id) return c;
        try {
          const res = await fetch('/api/characters/' + encodeURIComponent(c.character_id), { cache: 'no-store' });
          if (!res.ok) return c;
          const ch = await res.json();
          let sheet = {};
          if (ch && ch.sheet_json) {
            if (typeof ch.sheet_json === 'string') {
              try { sheet = JSON.parse(ch.sheet_json); } catch { sheet = {}; }
            } else if (typeof ch.sheet_json === 'object') {
              sheet = ch.sheet_json;
            }
          }
          const ident = sheet?.identity || {};
          const cls = ident.class || ident.class_name || ident.className || '';
          const lvl = ident.level != null ? String(ident.level) : '';
          const race = ident.race || '';
          return { ...c, class_name: cls, level: lvl, race };
        } catch {
          return c;
        }
      }));
      return enriched;
    }

    async function loadPortraitForPlayer(playerId, preferredCharacterId) {
      if (preferredCharacterId) {
        try {
          const chRes = await fetch('/api/characters/' + encodeURIComponent(preferredCharacterId), { cache: 'no-store' });
          if (!chRes.ok) return;
          const ch = await chRes.json();
          let sheet = {};
          if (ch && ch.sheet_json) {
            if (typeof ch.sheet_json === 'string') {
              try { sheet = JSON.parse(ch.sheet_json); } catch { sheet = {}; }
            } else if (typeof ch.sheet_json === 'object') {
              sheet = ch.sheet_json;
            }
          }
          let portraitUrl = sheet?.appearance?.portrait_url;
          if (!portraitUrl && preferredCharacterId) {
            portraitUrl = PORTRAIT_BASE + encodeURIComponent(preferredCharacterId) + '.jpg';
          }
          if (portraitUrl && elPassportPortrait && elPassportPortraitImg) {
            elPassportPortraitImg.src = portraitUrl;
            elPassportPortrait.hidden = false;
          }
          return;
        } catch {
          // fall back to first character
        }
      }
      if (!playerId) return;
      try {
        const res = await fetch('/api/players/' + encodeURIComponent(playerId) + '/characters', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        const rows = Array.isArray(data.rows) ? data.rows : [];
        const first = rows.find(r => r && r.character_id) || rows[0];
        if (!first || !first.character_id) return;

        const chRes = await fetch('/api/characters/' + encodeURIComponent(first.character_id), { cache: 'no-store' });
        if (!chRes.ok) return;
        const ch = await chRes.json();
        let sheet = {};
        if (ch && ch.sheet_json) {
          if (typeof ch.sheet_json === 'string') {
            try { sheet = JSON.parse(ch.sheet_json); } catch { sheet = {}; }
          } else if (typeof ch.sheet_json === 'object') {
            sheet = ch.sheet_json;
          }
        }
        let portraitUrl = sheet?.appearance?.portrait_url;
        if (!portraitUrl && first.character_id) {
          portraitUrl = PORTRAIT_BASE + encodeURIComponent(first.character_id) + '.jpg';
        }
        if (portraitUrl && elPassportPortrait && elPassportPortraitImg) {
          elPassportPortraitImg.src = portraitUrl;
          elPassportPortrait.hidden = false;
        }
      } catch {
        // ignore portrait failures
      }
    }

    async function init() {
      if (IS_SNAPSHOT) return;
      const params = new URLSearchParams(window.location.search);
      const playerId = params.get('player_id') || params.get('playerId');
      if (!playerId) {
        setStatus('No player_id in URL. Showing sample passport.');
        render(SAMPLE_PLAYER);
        if (SAMPLE_PLAYER.player_id) {
          loadPortraitForPlayer(SAMPLE_PLAYER.player_id, SAMPLE_PLAYER.passport_character_id);
        }
        renderCharacterTable(elSummaryCharacters, SAMPLE_PLAYER.characters || []);
        renderSummaryList(elSummaryCampaigns, SAMPLE_PLAYER.campaigns || [], 'campaign');
        return;
      }

      try {
        const res = await fetch('/api/players/' + encodeURIComponent(playerId), { cache: 'no-store' });
        if (!res.ok) throw new Error('Player not found');
        const player = await res.json();
        render(player);
        loadPortraitForPlayer(player.player_id, player.passport_character_id);
        const [charsRes, campsRes] = await Promise.all([
          fetch('/api/players/' + encodeURIComponent(playerId) + '/characters', { cache: 'no-store' }),
          fetch('/api/players/' + encodeURIComponent(playerId) + '/campaigns', { cache: 'no-store' })
        ]);
        const charsRaw = charsRes.ok ? (await charsRes.json()).rows || [] : [];
        const chars = await enrichCharacters(charsRaw);
        const camps = campsRes.ok ? (await campsRes.json()).rows || [] : [];
        renderCharacterTable(elSummaryCharacters, chars);
        renderSummaryList(elSummaryCampaigns, camps, 'campaign');
      } catch (err) {
        setStatus('Failed to load player. Showing sample passport.');
        render(SAMPLE_PLAYER);
        if (SAMPLE_PLAYER.player_id) {
          loadPortraitForPlayer(SAMPLE_PLAYER.player_id, SAMPLE_PLAYER.passport_character_id);
        }
        renderCharacterTable(elSummaryCharacters, SAMPLE_PLAYER.characters || []);
        renderSummaryList(elSummaryCampaigns, SAMPLE_PLAYER.campaigns || [], 'campaign');
      }
    }

    if (elPrint) {
      elPrint.addEventListener('click', () => window.print());
    }

    if (elCopyTokenBtn) {
      elCopyTokenBtn.addEventListener('click', () => {
        const token = elPassportToken?.textContent || '';
        if (!token || token === '--') return;
        if (!navigator.clipboard) return alert('Clipboard not available.');
        navigator.clipboard.writeText(token);
      });
    }

    async function toDataUrl(src) {
      const res = await fetch(src, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to fetch image');
      const blob = await res.blob();
      return await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    async function downloadPassport() {
      try {
        const clone = document.documentElement.cloneNode(true);
        clone.setAttribute('data-passport-snapshot', '1');

        const imgIds = ['passportBg', 'passportQrImg', 'passportPortraitImg'];
        for (const id of imgIds) {
          const img = document.getElementById(id);
          const cloneImg = clone.querySelector('#' + id);
          if (img && cloneImg && img.src && !img.src.startsWith('data:')) {
            try {
              const dataUrl = await toDataUrl(img.src);
              cloneImg.setAttribute('src', dataUrl);
            } catch {
              // ignore per-image failures
            }
          }
        }

        clone.querySelectorAll('script').forEach((node) => node.remove());
        const status = clone.querySelector('#status');
        if (status) status.remove();

        const html = '<!doctype html>\n' + clone.outerHTML;
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'player-passport.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      } catch (err) {
        alert('Failed to download passport.');
      }
    }

    if (elDownload) {
      elDownload.addEventListener('click', () => downloadPassport());
    }

    init();
  </script>
</body>
</html>

